<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC Online Exam</title>
<style>
/* ALL YOUR EXISTING CSS STAYS EXACTLY THE SAME */
/* ===== BASE STYLES ===== */
:root {
  --primary-color: #4B0082;
  --secondary-color: #af82ba;
  --light-purple: #E6E6FA;
  --white: #fff;
  --black: #000;
  --success: #32CD32;
  --warning: #ff9900;
  --danger: #ff6666;
  --shadow: 0 5px 15px rgba(0,0,0,0.1);
  --transition: all 0.3s ease;
}

* {
  box-sizing: border-box;
}

body {
  font-family: "SF Pro Display", Arial, sans-serif;
  margin: 0;
  background: var(--white);
  color: var(--black);
  line-height: 1.6;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Disable right-click context menu */
body {
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Enhanced Screenshot protection */
#screenshotProtection {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  z-index: 2147483647;
  pointer-events: none;
}

.screenshot-dots {
  position: absolute;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 10% 20%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 30% 40%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 50% 60%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 70% 80%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 90% 10%, rgba(255,255,255,0.02) 1px, transparent 1px);
  background-size: 200px 200px;
  animation: flicker 0.5s infinite;
}

@keyframes flicker {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 0.9; }
}

#screenshotBlock {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  z-index: 2147483646;
  pointer-events: none;
}

/* ===== HEADER & FOOTER ===== */
header {
  background:linear-gradient(145deg, var(--secondary-color), var(--light-purple));
  color: var(--primary-color);
  text-align: center;
  padding: 20px;
  font-size: 36px;
  font-weight: 700;
  letter-spacing: 1.5px;
  box-shadow: var(--shadow);
  text-shadow: 0 1px 2px var(--white);
}

footer {
  background: linear-gradient(145deg, var(--secondary-color), var(--light-purple));
  color: var(--primary-color);
  padding: 10px;
  text-align: center;
  font-weight: bold;
  position: fixed;
  width: 100%;
  bottom: 0;
}

/* ===== STUDENT ENTRY SECTION ===== */
#studentEntry {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: calc(100vh - 140px);
  padding: 16px;
  text-align: center;
}

.form-group {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  margin-bottom: 60px;
  width: 100%;
  max-width: 500px;
}

.form-group label {
  font-size: 1.15rem;
  font-weight: 600;
  margin-right: 10px;
  color: var(--primary-color);
  width: 180px;
  text-align: right;
}

input[type="text"], input[type="number"] {
  padding: 12px 14px;
  font-size: 1.1rem;
  border-radius: 10px;
  border: 1.5px solid var(--primary-color);
  outline: none;
  min-width: 250px;
  transition: var(--transition);
}

input[type="text"]:focus, input[type="number"]:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2);
}

input.error {
  animation: glowRed 0.5s alternate infinite;
  border-color: var(--danger);
}

@keyframes glowRed {
  0% { box-shadow: 0 0 5px var(--danger); }
  100% { box-shadow: 0 0 15px var(--danger); }
}

/* ===== BUTTON STYLES ===== */
button {
  position: relative;
  overflow: hidden;
  cursor: pointer;
  border: none;
  border-radius: 12px;
  transition: var(--transition);
  box-shadow: 0 6px #aaa;
  background: linear-gradient(to bottom, #fafaff, #dcd6f7);
  color: var(--primary-color);
  font-weight: 600;
  padding: 12px 24px;
  font-size: 18px;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 15px rgba(0,0,0,.28);
}

button:active {
  transform: translateY(3px) scale(.98);
}

button:focus {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

.optBtn {
  font-size: 16px;
  padding: 8px 18px;
  margin: 6px;
  border: 2px solid var(--primary-color);
  background: var(--white);
  border-radius: 8px;
  box-shadow: 0 5px #aaa;
}

.optBtn.selected {
  background: var(--success);
  color: var(--white);
  border-color: #2fa92f;
}

.optBtn.correct {
  background: #32CD32;
  color: white;
  border-color: #228B22;
}

.optBtn.wrong {
  background: #FF6B6B;
  color: white;
  border-color: #DC143C;
}

.optBtn.not-attempted {
  background: #B0B0B0;
  color: white;
  border-color: #808080;
}

.navBtn {
  font-size: 16px;
  padding: 10px 20px;
  border-radius: 8px;
  color: var(--white);
  font-weight: bold;
  cursor: pointer;
  background: linear-gradient(145deg, #1E90FF, #4682B4);
  margin: 0 15px;
}

#markReviewBtn {
  background: linear-gradient(145deg, #ffb84d, var(--warning));
}

#submitBtn {
  background: linear-gradient(145deg, #c8b88a, #b49e60);
}

/* ===== TIMER STYLES ===== */
#timerEl {
  font-size: 20px;
  font-weight: bold;
  color: var(--primary-color);
  padding: 6px 12px;
  border-radius: 6px;
  background: #f0f0ff;
  display: inline-block;
  transition: var(--transition);
}

#timerEl.blink {
  animation: blinkTimer 1s infinite;
}

@keyframes blinkTimer {
  0% { background: var(--danger); color: var(--white); }
  50% { background: var(--white); color: var(--primary-color); }
  100% { background: var(--danger); color: var(--white); }
}

/* ===== PALETTE STYLES ===== */
#paletteContainer {
  display: grid;
  gap: 8px;
  margin: 20px auto;
  max-width: 100%;
  padding: 0 10px;
  justify-content: center;
}

#paletteContainer button {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 14px;
  margin: 2px;
  border: 1px solid var(--primary-color);
  background: var(--light-purple);
  color: var(--primary-color);
  display: flex;
  align-items: center;
  justify-content: center;
}

#paletteContainer button.selected {
  background: var(--success);
  color: var(--white);
  border-color: #2fa92f;
}

#paletteContainer button.reviewed {
  background: yellow;
  color: var(--black);
}

#paletteContainer button.current {
  border: 3px solid red;
}

#paletteContainer button.correct-answer {
  background: #32CD32;
  color: white;
}

#paletteContainer button.wrong-answer {
  background: #FF6B6B;
  color: white;
}

#paletteContainer button.not-attempted-answer {
  background: #B0B0B0;
  color: white;
}

/* ===== EXAM AREA STYLES ===== */
#examArea {
  padding: 16px;
  text-align: center;
  display: none;
}

#examHeader {
  display: flex;
  align-items: center;
  width: 100%;
  font-weight: bold;
  margin-bottom: 20px;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e6e6fa;
}

#stuInfo {
  flex: 0 0 auto;
  text-align: left;
  white-space: nowrap;
  font-size: 18px;
  color: var(--primary-color);
}

#stuQInfo {
  flex: 1;
  text-align: center;
  white-space: nowrap;
  font-size: 20px;
  font-weight: bold;
  color: var(--primary-color);
}

/* ===== FIXED IMAGE STYLES ===== */
.question-image-container {
  width: 100%;
  min-height: 400px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 20px 0;
  padding: 10px;
  background: white;
  border-radius: 10px;
  border: 2px solid #E6E6FA;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.question-image {
  max-width: 100%;
  max-height: 500px;
  height: auto;
  border-radius: 8px;
  display: block;
  object-fit: contain;
}

/* Fallback image container */
.image-fallback {
  padding: 40px;
  background: white;
  border: 2px solid #ffcdd2;
  border-radius: 10px;
  color: #c62828;
  text-align: center;
  font-weight: bold;
  min-height: 300px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.image-fallback h3 {
  margin: 0 0 15px 0;
  color: #c62828;
  font-size: 24px;
}

.image-fallback p {
  margin: 5px 0;
  font-size: 16px;
}

/* ===== ANIMATIONS ===== */
.glow {
  animation: glowPulse 1.6s infinite alternate;
  box-shadow: 0 8px 18px rgba(75,0,130,0.12);
}

@keyframes glowPulse {
  0% { box-shadow: 0 6px 10px rgba(75,0,130,0.06); transform: translateY(0); }
  50% { box-shadow: 0 12px 30px rgba(75,0,130,0.14); transform: translateY(-2px); }
  100% { box-shadow: 0 6px 10px rgba(75,0,130,0.06); transform: translateY(0); }
}

/* ===== SECURITY OVERLAY STYLES ===== */
#fullRedOverlay {
  position: fixed;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  display: none;
  background: red;
  z-index: 9999;
  pointer-events: auto;
}

#accessDeniedBox {
  position: fixed;
  left: 50%;
  top: 40%;
  transform: translate(-50%, -50%);
  z-index: 10000;
  color: var(--white);
  text-align: center;
  display: none;
  pointer-events: auto;
}

#accessDeniedBox h1 {
  font-size: 48px;
  font-weight: 900;
  margin: 0 0 18px 0;
  color: var(--white);
  text-shadow: 0 2px 6px rgba(0,0,0,0.4);
}

#callAdminBtn {
  padding: 12px 22px;
  border-radius: 12px;
  font-weight: 800;
}

/* ===== MODAL STYLES ===== */
.confirmModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10001;
}

.confirmBox {
  background: var(--white);
  padding: 20px;
  border-radius: 12px;
  min-width: 280px;
  text-align: center;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.confirmBox p {
  font-size: 18px;
  color: var(--primary-color);
  margin-bottom: 15px;
}

.confirmBox button {
  margin: 0 10px;
  padding: 8px 16px;
  font-size: 16px;
  cursor: pointer;
}

#adminPassModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 20000;
}

#adminPassBox {
  background: var(--white);
  padding: 20px;
  text-align: center;
  width: 260px;
  border-radius: 12px;
}

#adminPassBox input {
  width: 90%;
  padding: 10px;
  border: 1px solid var(--primary-color);
  border-radius: 8px;
  margin-bottom: 10px;
}

/* ===== TIMER WARNING STYLES ===== */
.blinkLine {
  animation: blinkLineAnim 1s infinite;
}

@keyframes blinkLineAnim {
  0% { background: #ffcccc; }
  50% { background: var(--white); }
  100% { background: #ffcccc; }
}

/* ===== VIOLATION WARNING OVERLAY STYLES ===== */
#violationWarningOverlay {
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255, 0, 0, 0.95);
  color: white;
  padding: 25px 35px;
  border-radius: 15px;
  z-index: 10002;
  text-align: center;
  font-weight: bold;
  font-size: 20px;
  border: 4px solid white;
  box-shadow: 0 0 40px red;
  animation: pulse 1s infinite;
  max-width: 80%;
  min-width: 300px;
}

@keyframes fadeOut {
  from { opacity: 1; }
  to { opacity: 0; }
}

/* ===== ERROR MESSAGE STYLES ===== */
.error-message {
  color: #ff3333;
  font-weight: 600;
  padding: 10px;
  margin: 10px 0;
  border-radius: 6px;
  background: rgba(255, 102, 102, 0.1);
  border: 1px solid #ff6666;
  animation: blinkRed 1s infinite;
}

@keyframes blinkRed {
  0% { opacity: 1; }
  50% { opacity: 0.6; }
  100% { opacity: 1; }
}

/* ===== RESULTS TABLE STYLES ===== */
.results-table {
  width: 100%;
  max-width: 900px;
  margin: 20px auto;
  border-collapse: collapse;
  font-size: 18px;
  text-align: center;
}

.results-table th {
  background: #E6E6FA;
  padding: 15px;
  border: 1px solid var(--primary-color);
}

.results-table td {
  padding: 15px;
  border: 1px solid var(--primary-color);
}

.results-table tr:nth-child(even) {
  background: #f9f9f9;
}

.results-table tr:hover {
  background: #f0f0ff;
}

/* ===== REVIEW MODE STYLES ===== */
.answer-status {
  margin: 10px 0;
  padding: 10px;
  border-radius: 8px;
  font-weight: bold;
}

.answer-status.correct {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.answer-status.wrong {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.answer-status.not-attempted {
  background: #e2e3e5;
  color: #383d41;
  border: 1px solid #d6d8db;
}

.correct-answer {
  color: #155724;
  font-weight: bold;
}

.wrong-answer {
  color: #721c24;
  font-weight: bold;
}

/* ===== AREA STYLES ===== */
#summaryArea, #reviewArea {
  display: none;
  padding: 20px;
}

.area-header {
  text-align: center;
  margin-bottom: 30px;
}

.area-header h2 {
  color: #4B0082;
  margin-bottom: 10px;
}

/* ===== VERTICAL GAP STYLES ===== */
.options-container {
  margin-bottom: 60px;
}

.navContainer {
  margin-top: 40px;
  display: flex;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
}

/* ===== SECURITY MESSAGE STYLES ===== */
.security-message {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  color: #856404;
  padding: 15px;
  border-radius: 8px;
  margin: 20px 0;
  text-align: center;
  font-weight: bold;
}

/* ===== AUTO TRANSITION STYLES ===== */
.auto-transition-message {
  background: #d4edda;
  border: 1px solid #c3e6cb;
  color: #155724;
  padding: 15px;
  border-radius: 8px;
  margin: 20px 0;
  text-align: center;
  font-weight: bold;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}
.waiting-message {
  background: #d1ecf1;
  border: 1px solid #bee5eb;
  color: #0c5460;
  padding: 20px;
  border-radius: 8px;
  margin: 30px 0;
  text-align: center;
  font-weight: bold;
  font-size: 18px;
}

.waiting-timer {
  font-size: 24px;
  font-weight: bold;
  color: #4B0082;
  margin: 10px 0;
}

/* ===== ACCESS DENIED SCREEN STYLES ===== */
.access-denied {
  display: flex;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background:linear-gradient(145deg, var(--secondary-color), var(--light-purple)) ;
  z-index: 10000;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color:black;
  text-align: center;
  padding: 20px;
}

.access-denied h1 {
  font-size: 3em;
  margin-bottom: 20px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
   color: #4B0082;
}

.access-code-input {
  padding: 12px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  width: 300px;
  text-align: center;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.verify-btn {
  background: white;
  color: #4B0082;
  border: none;
  padding: 12px 30px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.verify-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}

.access-error {
  color: #ffeb3b;
  margin-top: 10px;
  font-weight: 600;
  display: none;
}

/* ===== RESUBMISSION STYLES ===== */
#resubmissionSection {
  background: #fff3cd;
  border: 2px solid #ffc107;
  border-radius: 10px;
  padding: 20px;
  margin: 20px 0;
  text-align: center;
  display: none;
}

#resubmissionSection h3 {
  color: #856404;
  margin-bottom: 15px;
}

#resubmissionPassword {
  padding: 10px;
  border: 1px solid #ffc107;
  border-radius: 5px;
  margin: 10px 0;
  width: 200px;
  text-align: center;
  font-size: 16px;
}

.resubmit-btn {
  background: linear-gradient(145deg, #ffc107, #e0a800);
  color: #856404;
  margin: 5px;
  padding: 8px 16px;
}

.resubmit-btn:hover {
  background: linear-gradient(145deg, #e0a800, #d39e00);
  transform: translateY(-2px);
}

/* ===== GOOGLE FORMS STATUS STYLES ===== */
.submission-status {
  padding: 15px;
  margin: 10px 0;
  border-radius: 8px;
  text-align: center;
  font-weight: bold;
}

.submission-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.submission-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb);
}

.submission-pending {
  background: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}

/* ===== DOWNLOAD BUTTON STYLES ===== */
.download-section {
  text-align: center;
  margin: 30px 0;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 10px;
  border: 2px solid #e9ecef;
}

.download-btn {
  background: linear-gradient(145deg, #28a745, #20c997);
  color: white;
  padding: 12px 30px;
  font-size: 18px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin: 10px;
}

/* ===== UPDATED SMALLER 3x3 NUMERICAL KEYPAD STYLES ===== */
.numerical-keypad {
  margin: 10px auto;
  max-width:175px;
}

.keypad-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 6px;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #4B0082;
  box-shadow: 0 2px 4px rgba(75, 0, 130, 0.1);
}

.num-key-btn {
  width: 45px;
  height: 45px;
  font-size: 18px;
  font-weight: bold;
  border: 1px solid #4B0082;
  border-radius: 6px;
  background: linear-gradient(145deg, #ffffff, #f0f0ff);
  color: #4B0082;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 0 rgba(75, 0, 130, 0.2);
}

.num-key-btn:hover {
  background: linear-gradient(145deg, #f0f0ff, #e6e6fa);
  transform: translateY(-1px);
  box-shadow: 0 3px 0 rgba(75, 0, 130, 0.3);
}

.num-key-btn:active {
  transform: translateY(1px);
  box-shadow: 0 1px 0 rgba(75, 0, 130, 0.2);
}

.num-key-btn:focus {
  outline: 2px solid #4B0082 !important;
  outline-offset: 1px;
  box-shadow: 0 0 0 2px rgba(75, 0, 130, 0.2) !important;
}

.special-btn {
  font-size: 18px;
}

.clear-btn {
  background: linear-gradient(145deg, #ff9900, #ff8c00);
  color: white;
  border-color: #ff8c00;
}

.submit-num-btn {
  background: linear-gradient(145deg, #32CD32, #228B22);
  color: white;
  border-color: #228B22;
  font-size: 20px;
}

/* Tab navigation focus styles */
.fill-blank-input:focus {
  outline: 2px solid #4B0082 !important;
  outline-offset: 1px;
  box-shadow: 0 0 0 2px rgba(75, 0, 130, 0.2) !important;
}

.optBtn:focus {
  outline: 2px solid #4B0082 !important;
  outline-offset: 1px;
  box-shadow: 0 0 0 2px rgba(75, 0, 130, 0.2) !important;
}

.navBtn:focus {
  outline: 2px solid #4B0082 !important;
  outline-offset: 1px;
  box-shadow: 0 0 0 2px rgba(75, 0, 130, 0.2) !important;
}

.palette-btn:focus {
  outline: 2px solid #4B0082 !important;
  outline-offset: 1px;
  box-shadow: 0 0 0 2px rgba(75, 0, 130, 0.2) !important;
}

/* Responsive keypad */
@media (max-width: 400px) {
  .keypad-grid {
    gap: 5px;
    padding: 6px;
  }
  
  .num-key-btn {
    width: 40px;
    height: 40px;
    font-size: 16px;
  }
}

/* ===== TOAST NOTIFICATION STYLES ===== */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 24px;
  border-radius: 8px;
  color: white;
  font-weight: bold;
  z-index: 10000;
  animation: toastSlideIn 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.toast-success {
  background: linear-gradient(145deg, #32CD32, #228B22);
}

.toast-warning {
  background: linear-gradient(145deg, #FFA500, #FF8C00);
}

.toast-error {
  background: linear-gradient(145deg, #FF4500, #DC143C);
}

.toast-info {
  background: linear-gradient(145deg, #1E90FF, #4682B4);
}

@keyframes toastSlideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes toastSlideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

/* ===== TAB SWITCH WARNING STYLES ===== */
.tab-switch-warning {
  position: fixed;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(145deg, #FFA500, #FF8C00);
  color: white;
  padding: 20px 30px;
  border-radius: 10px;
  font-weight: bold;
  z-index: 10001;
  text-align: center;
  box-shadow: 0 5px 20px rgba(255, 165, 0, 0.3);
  animation: slideDown 0.5s ease;
  font-size: 18px;
  min-width: 350px;
  max-width: 80%;
  border: 2px solid #ff8c00;
}

@keyframes slideDown {
  from { top: 50px; opacity: 0; }
  to { top: 100px; opacity: 1; }
}

@keyframes slideUp {
  from { top: 100px; opacity: 1; }
  to { top: 50px; opacity: 0; }
}

@keyframes shakeWarning {
  0%, 100% { transform: translateX(-50%); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(calc(-50% - 5px)); }
  20%, 40%, 60%, 80% { transform: translateX(calc(-50% + 5px)); }
}

/* ===== FULL-SCREEN WARNING OVERLAY STYLES ===== */
#fullscreen-warning-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  z-index: 2147483646;
  display: none;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  color: white;
  font-family: Arial, sans-serif;
  text-align: center;
}

#fullscreen-warning-overlay .warning-content {
  background: rgba(255, 0, 0, 0.2);
  padding: 40px;
  border-radius: 20px;
  border: 3px solid rgba(255, 0, 0, 0.5);
  max-width: 500px;
  width: 90%;
  backdrop-filter: blur(10px);
}

#fullscreen-warning-overlay h2 {
  color: #ff6b6b;
  font-size: 28px;
  margin-bottom: 15px;
}

#fullscreen-warning-overlay p {
  font-size: 18px;
  margin-bottom: 25px;
  line-height: 1.5;
}

#enter-fullscreen-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 15px 40px;
  font-size: 18px;
  border-radius: 25px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

#enter-fullscreen-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
}

#enter-fullscreen-btn:active {
  transform: translateY(0);
}

/* ===== POWER LOSS RECOVERY OVERLAY STYLES ===== */
#powerLossRecoveryOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  z-index: 99999;
  display: none;
  justify-content: center;
  align-items: center;
  color: white;
  font-family: Arial, sans-serif;
  text-align: center;
}

#powerLossRecoveryBox {
  background: linear-gradient(145deg, #1a1a2e, #162447);
  padding: 40px;
  border-radius: 20px;
  max-width: 600px;
  width: 90%;
  border: 3px solid #4B0082;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

#powerLossRecoveryBox h2 {
  color: #4B0082;
  margin-bottom: 25px;
  font-size: 28px;
}

.recovery-details {
  background: rgba(255, 255, 255, 0.1);
  padding: 20px;
  border-radius: 10px;
  margin: 20px 0;
  text-align: left;
}

.recovery-details p {
  margin: 10px 0;
  font-size: 16px;
}

.recovery-progress {
  margin: 20px 0;
  padding: 15px;
  background: rgba(75, 0, 130, 0.2);
  border-radius: 10px;
}

.progress-bar {
  width: 100%;
  height: 10px;
  background: #333;
  border-radius: 5px;
  margin: 10px 0;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #4B0082, #8A2BE2);
  border-radius: 5px;
  transition: width 0.3s ease;
}

.recovery-options {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 30px;
}

.recovery-btn {
  padding: 12px 30px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
}

#resumeExamRecoveryBtn {
  background: linear-gradient(145deg, #32CD32, #228B22);
  color: white;
}

#discardExamRecoveryBtn {
  background: linear-gradient(145deg, #dc3545, #c82333);
  color: white;
}

.recovery-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

/* ===== CONNECTION STATUS STYLES ===== */
#connectionStatus {
  position: fixed;
  bottom: 50px;
  right: 10px;
  background: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  z-index: 10000;
  display: flex;
  align-items: center;
  gap: 6px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  border-left: 3px solid #32CD32;
  transition: all 0.3s ease;
}

#autoSaveIndicator {
  position: fixed;
  bottom: 85px;
  right: 10px;
  background: rgba(75, 0, 130, 0.9);
  color: white;
  padding: 5px 10px;
  border-radius: 4px;
  font-size: 11px;
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.3s ease;
}

#autoSaveIndicator.show {
  opacity: 1;
}

/* ===== RESUME EXAM STYLES ===== */
#resumeExamSection {
  display: none;
  margin-top: 20px;
  padding: 20px;
  background: #fff3cd;
  border: 2px solid #ffc107;
  border-radius: 10px;
  text-align: center;
}

#resumeExamSection h3 {
  color: #856404;
  margin-bottom: 15px;
}

.resume-student-info {
  background: white;
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
  text-align: left;
  display: inline-block;
}

.resume-options {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 20px;
  flex-wrap: wrap;
}

.resume-btn {
  padding: 10px 25px;
  font-size: 16px;
  font-weight: bold;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
}

.resume-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

#resumeExamBtn {
  background: linear-gradient(145deg, #32CD32, #228B22);
  color: white;
}

#startNewBtn {
  background: linear-gradient(145deg, #dc3545, #c82333);
  color: white;
}

/* ===== RESPONSIVE STYLES ===== */
@media (max-width: 600px) {
  #accessDeniedBox h1 {
    font-size: 28px;
  }
  
  #callAdminBtn {
    padding: 10px 14px;
  }
  
  .form-group {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .form-group label {
    text-align: left;
    width: auto;
    margin-bottom: 5px;
  }
  
  #examHeader {
    flex-direction: column;
    gap: 10px;
    text-align: center;
  }
  
  #stuInfo, #stuQInfo {
    text-align: center;
    width: 100%;
  }
  
  .navContainer {
    flex-direction: column;
    align-items: center;
  }
  
  .navBtn {
    width: 80%;
    margin-bottom: 10px;
    margin-left: 0;
    margin-right: 0;
  }
  
  #paletteContainer {
    grid-template-columns: repeat(5, 1fr) !important;
    gap: 6px;
  }
  
  #paletteContainer button {
    width: 35px;
    height: 35px;
    font-size: 12px;
  }
  
  .question-image-container {
    min-height: 300px;
  }
  
  .question-image {
    max-height: 350px;
  }
  
  .tab-switch-warning {
    font-size: 14px;
    padding: 15px 20px;
    min-width: 280px;
  }
  
  #violationWarningOverlay {
    font-size: 16px;
    padding: 15px 20px;
    min-width: 250px;
  }
}

@media (min-width: 601px) and (max-width: 900px) {
  #paletteContainer {
    grid-template-columns: repeat(10, 1fr) !important;
  }
}

@media (min-width: 901px) and (max-width: 1200px) {
  #paletteContainer {
    grid-template-columns: repeat(15, 1fr) !important;
  }
}

@media (min-width: 1201px) {
  #paletteContainer {
    grid-template-columns: repeat(20, 1fr) !important;
  }
}

/* ===== ANTI-SLEEP CLICK FEEDBACK STYLES ===== */
@keyframes clickFeedback {
  0% { transform: scale(0.5); opacity: 1; }
  100% { transform: scale(2); opacity: 0; }
}

/* Keep-awake animation */
@keyframes antiSleepPulse {
  0% { transform: translateY(0); }
  100% { transform: translateY(0.1px); }
}

body.anti-sleep-active {
  animation: antiSleepPulse 60s infinite;
}
</style>
</head>

<body>

<!-- Power Loss Recovery Overlay -->
<div id="powerLossRecoveryOverlay">
  <div id="powerLossRecoveryBox">
    <h2>‚ö° EXAM RECOVERY AVAILABLE</h2>
    
    <div class="recovery-details">
      <p id="recoveryStudentName"><strong>Student:</strong> Loading...</p>
      <p id="recoveryLastSave"><strong>Last Save:</strong> Loading...</p>
      <p id="recoveryProgress"><strong>Progress:</strong> Loading...</p>
      <p id="recoveryTimeLeft"><strong>Time Remaining:</strong> Loading...</p>
    </div>
    
    <div class="recovery-progress">
      <p><strong>Recovery Status:</strong> <span id="recoveryStatus">Checking data...</span></p>
      <div class="progress-bar">
        <div class="progress-fill" id="recoveryProgressBar" style="width: 0%"></div>
      </div>
    </div>
    
    <div class="recovery-options">
      <button id="resumeExamRecoveryBtn" class="recovery-btn">‚úÖ RESUME EXAM</button>
      <button id="discardExamRecoveryBtn" class="recovery-btn">üóëÔ∏è START FRESH</button>
    </div>
    
    <p style="margin-top: 20px; font-size: 14px; color: #aaa;">
      <em>Your exam progress was automatically saved. You can resume where you left off.</em>
    </p>
  </div>
</div>

<!-- Access Denied Screen - ALWAYS SHOWS FIRST -->
<div id="accessDenied" class="access-denied">
    <h1>LFJC ONLINE EXAMINATION</h1>
    <p style="font-size: 1.2em; margin: 10px 0;">TOTAL 75 QUESTIONS</p>
    <p style="margin: 5px 0;">‚Ä¢ Maths: 20 (MCQ), 5 (Numerical Input)</p>
    <p style="margin: 5px 0;">‚Ä¢ Physics: 20 (MCQ), 5(Numerical Input)</p>
    <p style="margin: 5px 0;">‚Ä¢ Chemistry: 20 (MCQ), 5 (Numerical Input)</p>
    <p style="margin: 10px 0; font-weight: bold;">CORRECT ANSWER + 4 MARKS</p>
    <p style="margin: 5px 0; font-weight: bold;">WRONG ANSWER -1 MARK</p>
    <p style="margin: 15px 0; max-width: 600px; line-height: 1.5;">
       
    <input type="password" id="accessCode" class="access-code-input" placeholder="Enter Access Code">
    <button id="verifyAccess" class="verify-btn">VERIFY ACCESS</button>
    <div id="accessError" class="access-error">‚ùå Invalid access code. Please try again.</div>
</div>

<header>LFJC ONLINE EXAMINATION</header>

<div id="studentEntry" style="display:none;">
  <div class="warning-banner" id="examWarning" style="display:none;">
    <p>‚ö†Ô∏è WARNING: Exam in progress. Do not refresh or close this window!</p>
  </div>
  
  <div class="form-group"><label>NAME</label><input type="text" id="stuName" placeholder="Only letters & spaces" autocomplete="off"></div>
  <div class="form-group"><label>SECTION</label><input type="text" id="stuSection" placeholder="Letters & digits" autocomplete="off"></div>
  <div class="form-group"><label>ROLL NUMBER</label><input type="text" id="stuRoll" placeholder="Digits only" autocomplete="off"></div>
  <div class="form-group"><label>ADMISSION NUMBER</label><input type="text" id="stuAdm" placeholder="Digits only" autocomplete="off"></div>

  <!-- REMOVED: Form Assignment Display -->
  
  <!-- RESUME EXAM SECTION -->
  <div id="resumeExamSection">
    <h3>üîÑ Exam In Progress Found</h3>
    <div class="resume-student-info">
      <p><strong>Student:</strong> <span id="resumeStudentName">Loading...</span></p>
      <p><strong>Section:</strong> <span id="resumeSection">Loading...</span></p>
      <p><strong>Progress:</strong> <span id="resumeProgress">Loading...</span></p>
      <p><strong>Time Left:</strong> <span id="resumeTimeLeft">Loading...</span></p>
    </div>
    <p style="margin-bottom: 15px;">You have an exam in progress from a previous session.</p>
    <div class="resume-options">
      <button id="resumeExamBtn" class="resume-btn">Continue Exam</button>
      <button id="startNewBtn" class="resume-btn">Start New Exam</button>
    </div>
  </div>

  <!-- RESUBMISSION SECTION -->
  <div id="resubmissionSection">
    <h3>üîÑ Re-submission Required</h3>
    <p>You have already submitted within the last 24 hours.</p>
    <p>To submit again, please enter the re-submission password:</p>
    <input type="password" id="resubmissionPassword" placeholder="Enter re-submission password">
    <div>
      <button id="verifyResubmission" class="resubmit-btn">Verify & Re-submit</button>
      <button id="cancelResubmission" class="resubmit-btn">Cancel</button>
    </div>
  </div>

  <!-- Google Forms Submission Status -->
  <div id="googleFormsStatus" style="display:none;"></div>

  <div class="form-group"><button id="stuStartBtn" style="display:none;">Start Exam</button></div>
  <p id="studentMsg"></p>
  <div id="errorMessages"></div>
</div>

<div id="examArea" style="display:none;">
  <div id="examHeader">
    <div id="stuInfo"></div>
    <div id="stuQInfo"></div>
    <div>
        <span id="timerEl">üïí 00:00</span>
    </div>
  </div>

  <div id="questionContainer" style="text-align:center;margin-top:10px;"></div>

  <div class="navContainer">
    <button class="navBtn" id="prevBtn">‚¨Ö Previous</button>
    <button class="navBtn" id="markReviewBtn">Review</button>
    <button class="navBtn" id="nextBtn">Next ‚û°</button>
    <button class="navBtn" id="submitBtn">Submit Exam</button>
  </div>

  <div id="paletteContainer"></div>
</div>

<!-- Summary Area -->
<div id="summaryArea">
  <div class="area-header">
    <h2>üìä Exam Summary - <span id="summaryStudentName"></span></h2>
    <div>
      <b>Section:</b> <span id="summarySection"></span> | 
      <b>Roll:</b> <span id="summaryRoll"></span> | 
      <b>Admission No:</b> <span id="summaryAdm"></span>
      <!-- REMOVED: | <b>Form:</b> <span id="summaryForm"></span> -->
    </div>
  </div>
  
  <div id="summaryTableContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;"></div>
  
  <!-- Google Forms Submission Status in Summary -->
  <div id="summarySubmissionStatus" style="margin: 20px auto; max-width: 600px;"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <div id="waitingMessage" class="waiting-message">
      <div>‚è≥ Waiting for Exam Time to Complete</div>
      <div class="waiting-timer" id="waitingTimer">00:00</div>
      <div>Detailed solutions will be available automatically when the exam time is over.</div>
    </div>
    <div id="autoTransitionMessage" class="auto-transition-message" style="display:none;">
      üîÑ Auto-transitioning to detailed solutions in <span id="countdown">5</span> seconds...
    </div>
    <button id="closeSummaryBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close</button>
  </div>
</div>

<!-- Review Area -->
<div id="reviewArea">
  <div class="area-header">
    <h2>üìù Detailed Solutions - <span id="reviewStudentName"></span></h2>
    <div>
      <b>Section:</b> <span id="reviewSection"></span> | 
      <b>Roll:</b> <span id="reviewRoll"></span> | 
      <b>Admission No:</b> <span id="reviewAdm"></span>
      <!-- REMOVED: | <b>Form:</b> <span id="reviewForm"></span> -->
    </div>
  </div>
  
  <!-- Results Table in Detailed Solutions -->
  <div id="detailedResultsContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;margin:30px 0;"></div>
  
  <!-- Download Section -->
  <div id="downloadSection" class="download-section">
    <h4 style="color: #4B0082; margin-bottom: 15px;">üì• Download Your Answer Sheet</h4>
    <button onclick="downloadStudentCSV()" class="download-btn">
      üíæ Download Complete Answer Sheet (CSV)
    </button>
    <p style="margin-top: 10px; color: #6c757d;">
      <small>Contains all your answers in original question order (Q1, Q2, Q3...). Perfect for analysis in Excel.</small>
    </p>
  </div>
  
  <!-- Detailed Solutions Container -->
  <div id="reviewQuestionsContainer"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <button id="closeReviewBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close</button>
  </div>
</div>

<footer>¬© LFJC 2025 All Rights Reserved</footer>

<!-- Security Overlays -->
<div id="fullRedOverlay"></div>
<div id="accessDeniedBox">
  <h1>ACCESS DENIED</h1>
  <button id="callAdminBtn" class="glow">Enter Password</button>
</div>

<!-- Modals -->
<div class="confirmModal" id="confirmModal">
  <div class="confirmBox">
    <p id="confirmText">Confirm?</p>
    <button id="confirmYes">Yes</button>
    <button id="confirmNo">No</button>
  </div>
</div>

<div id="adminPassModal">
  <div id="adminPassBox">
    <h3>Enter Admin Password</h3>
    <input type="password" id="adminPassInput">
    <br><br>
    <button id="adminPassSubmit">Submit</button>
  </div>
</div>

<!-- Chrome Menu Blur Overlay -->
<div id="chromeMenuBlurOverlay"></div>

<!-- Connection Status Indicator -->
<div id="autoSaveIndicator">Auto-saved ‚úì</div>

<script>
// ===== CONFIGURATION =====
const MARK_PER_CORRECT = 4, MARK_PER_WRONG = -1;
const EXAM_DURATION_MINUTES = 180; // 3 hours for 75 questions
const EXAM_DURATION_MS = EXAM_DURATION_MINUTES * 60 * 1000;
const STORAGE_KEY_PREFIX = "lfjc_exam_";
const MAX_QUESTIONS = 75;
const ACCESS_CODE = "lfjc2025";
const ADMIN_PASSWORD = "admin2025";
const RESUBMISSION_PASSWORD = "resubmit2025";
const RESUBMISSION_WINDOW_HOURS = 24;

// EXTERNAL ANSWER KEY CONFIGURATION
const ANSWER_KEY_URL = 'answer-key.txt'; // External file containing the key
let answerKey = []; // Will be loaded from external file
let keyLoaded = false;

// POWER LOSS PROTECTION CONFIG
const AUTO_SAVE_INTERVAL = 15; // seconds
const RECOVERY_WINDOW_HOURS = 4; // Allow recovery within 4 hours
const STORAGE_KEYS = {
    EXAM_PROGRESS: 'lfjc_exam_progress_v2',
    EXAM_METADATA: 'lfjc_exam_metadata',
    LAST_SAVE_TIME: 'lfjc_last_save',
    ANSWERS_BACKUP: 'lfjc_answers_backup',
    EXAM_STATE: 'lfjc_exam_state',
    PENDING_SUBMISSIONS: 'lfjc_pending_submissions'
};

// QUESTION STRUCTURE CONFIGURATION
const QUESTION_STRUCTURE = {
  total: 75,
  subjects: [
    { 
      name: "Physics", 
      start: 1, 
      end: 25, 
      mcqRange: [1, 20], 
      fillBlanksRange: [21, 25]
    },
    { 
      name: "Chemistry", 
      start: 26, 
      end: 50, 
      mcqRange: [26, 45], 
      fillBlanksRange: [46, 50]
    },
    { 
      name: "Maths", 
      start: 51, 
      end: 75, 
      mcqRange: [51, 70], 
      fillBlanksRange: [71, 75]
    }
  ]
};

// ===== MULTI-FORM GOOGLE FORMS INTEGRATION =====
const GOOGLE_FORMS = {
    'A': "https://docs.google.com/forms/d/e/1FAIpQLSe4uuphhY4-p5jdTZqxG_ZZUKAhQZF1ytyNizPXb0n3L85JIw/formResponse",
    'B': "https://docs.google.com/forms/d/e/1FAIpQLSc3JIcnUysvUtH12QWpHG9wAF4vd1NgEYqeyHwNP0UEkPqi5w/formResponse", 
    'C': "https://docs.google.com/forms/d/e/1FAIpQLScqYdTGoD4l0jJvzYw0tdBNRSMPepnGtOOowOXYwDFov43KHg/formResponse",
    'D': "https://docs.google.com/forms/d/e/1FAIpQLSfjAyDlY-5BAF5rPvzQS0AeTI6Vs2Rkri0V6_miA0mRivZAEg/formResponse",
    'E': "https://docs.google.com/forms/d/e/1FAIpQLSfK6Skl6Uxj8VyGnhhqfdPHcJ8mbcgpzIKLpWFElzdeQSKMgA/formResponse",
    'F': "https://docs.google.com/forms/d/e/1FAIpQLSeP-Gx2XnUg_Q17asOOeYzkoGtLykVIcQ2W006YTqTpE7xY6g/formResponse",
    'G': "https://docs.google.com/forms/d/e/1FAIpQLSe1vg_I5XR3ljr-UNFi-MXxUgjdTDyrVbHxqi_dkvtmYGUTEA/formResponse",
    'H': "https://docs.google.com/forms/d/e/1FAIpQLScyv8cps4StN2UXrsXqNdLu5UBR7t0Vwk8WSnynU2tvracs1g/formResponse",
    'I': "https://docs.google.com/forms/d/e/1FAIpQLSeyen2hSdhRwztpWnH6lyuL91ZROqwDMKIaa4gN_e-Xvyvb_g/formResponse",
    'J': "https://docs.google.com/forms/d/e/1FAIpQLSelbDi1n1EKWu7G0I92hTML6vWUO2c55p2dqrEOQ7cWflaSNg/formResponse"
};

const COMMON_FIELDS = {
    STUDENT_NAME: "entry.217666919",
    SECTION: "entry.2006392966", 
    ROLL_NUMBER: "entry.547275105",
    ADMISSION_NUMBER: "entry.1234063852",
    MATHS_MARKS: "entry.1989859216",
    PHYSICS_MARKS: "entry.1953974928", 
    CHEMISTRY_MARKS: "entry.296331194",
    TOTAL_MARKS: "entry.1289040887",
    TIMESTAMP: "entry.2139100252"
};

const ANSWERS_FIELDS = {
    'A': "entry.224183536",
    'B': "entry.2135062491",
    'C': "entry.66262823",
    'D': "entry.762314240",
    'E': "entry.109746612",
    'F': "entry.813348755",
    'G': "entry.1184321804",
    'H': "entry.64526224",
    'I': "entry.1618336199",
    'J': "entry.1279707071"
};

// ===== GLOBAL VARIABLES =====
let images = [];
let hasSubmitted = false;
let examStartTime = null;
let waitingTimerInterval = null;
let autoTransitionTimer = null;
let examInProgress = false;
let preloadedImages = {};
let currentSubjData = null;
let adminOverrideActive = false;
let assignedForm = 'A';
let isResubmission = false;
let submissionInProgress = new Set();
let googleFormsSubmissionStatus = 'pending';
let chromeMenuBlurDetector = null;
let tabSwitchCount = 0;
let lastTabSwitchTime = 0;
let fullScreenExitTimeout = null;
let autoSaveTimer = null;
let connectionStatusElement = null;
let autoSaveIndicator = null;
let powerLossRecoveryData = null;
let resumeInProgress = false;

// ===== AUTO-CLICK SYSTEM VARIABLES =====
let autoClickInterval = null;
let keepAwakeSystem = null;

// SYSTEM TRAY SECURITY VARIABLES
let systemTrayViolations = 0;
const MAX_SYSTEM_TRAY_VIOLATIONS = 3;
let lastSystemTrayViolationTime = 0;
let systemTrayCheckInterval = null;
let systemTrayDetector = null;

const subjects = ["Physics", "Chemistry", "Maths"];
let examData = {files: [], subjectNames: [], keys: [], originalOrder: [], questionTypes: []};
let progress = null, timerInterval = null;

// ===== AUTO-CLICK SYSTEM =====
function startAutoClick() {
    if (autoClickInterval) {
        clearInterval(autoClickInterval);
    }
    
    console.log('üñ±Ô∏è Starting auto-click system (every 30 seconds)');
    
    // Track real clicks to simulate in similar positions
    document.addEventListener('click', function(e) {
        window.lastClickPosition = { x: e.clientX, y: e.clientY };
    });
    
    // Start with default position (center of screen)
    if (!window.lastClickPosition) {
        window.lastClickPosition = {
            x: window.innerWidth / 2,
            y: window.innerHeight / 2
        };
    }
    
    autoClickInterval = setInterval(function() {
        if (!examInProgress || document.hidden) return;
        
        try {
            // Generate a real click event
            performAutoClick();
        } catch (error) {
            console.error('Auto-click error:', error);
        }
    }, 30000); // Every 30 seconds
    
    // Also do an immediate click
    setTimeout(performAutoClick, 1000);
}

function performAutoClick() {
    if (!examInProgress) return;
    
    const currentTime = Date.now();
    
    // Don't click too frequently (safety check)
    if (window.lastAutoClickTime && currentTime - window.lastAutoClickTime < 1000) {
        return;
    }
    
    window.lastAutoClickTime = currentTime;
    
    // Generate random position near last click (so it's not always same spot)
    const randomX = window.lastClickPosition.x + (Math.random() * 100 - 50);
    const randomY = window.lastClickPosition.y + (Math.random() * 100 - 50);
    
    // Ensure position is within viewport
    const safeX = Math.max(10, Math.min(window.innerWidth - 10, randomX));
    const safeY = Math.max(10, Math.min(window.innerHeight - 10, randomY));
    
    console.log(`üñ±Ô∏è Auto-clicking at position (${Math.round(safeX)}, ${Math.round(safeY)})`);
    
    // Create and dispatch ALL mouse events to simulate real click
    simulateRealClick(safeX, safeY);
    
    // Also update stored position
    window.lastClickPosition.x = safeX;
    window.lastClickPosition.y = safeY;
}

function simulateRealClick(x, y) {
    try {
        // Get the element at this position
        const element = document.elementFromPoint(x, y) || document.body;
        
        if (!element) return;
        
        // Create full sequence of mouse events (like real click)
        const events = [
            { type: 'mousemove', clientX: x, clientY: y },
            { type: 'mousedown', clientX: x, clientY: y, button: 0 },
            { type: 'mouseup', clientX: x, clientY: y, button: 0 },
            { type: 'click', clientX: x, clientY: y, button: 0 }
        ];
        
        events.forEach(eventConfig => {
            const event = new MouseEvent(eventConfig.type, {
                view: window,
                bubbles: true,
                cancelable: true,
                clientX: eventConfig.clientX,
                clientY: eventConfig.clientY,
                button: eventConfig.button || 0,
                buttons: eventConfig.type === 'mousedown' ? 1 : 0
            });
            
            element.dispatchEvent(event);
        });
        
        // Also focus the element if it's focusable
        if (element.tabIndex >= 0 || 
            element.tagName === 'INPUT' || 
            element.tagName === 'BUTTON' ||
            element.tagName === 'TEXTAREA' ||
            element.tagName === 'SELECT') {
            element.focus();
        }
        
        // Visual feedback (optional - for debugging)
        showClickFeedback(x, y);
        
    } catch (error) {
        console.error('Click simulation error:', error);
    }
}

function showClickFeedback(x, y) {
    // Create a temporary visual indicator
    const feedback = document.createElement('div');
    feedback.style.cssText = `
        position: fixed;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(0, 255, 0, 0.3);
        border: 2px solid rgba(0, 255, 0, 0.7);
        pointer-events: none;
        z-index: 999999;
        left: ${x - 10}px;
        top: ${y - 10}px;
        animation: clickFeedback 0.5s forwards;
    `;
    
    document.body.appendChild(feedback);
    
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.parentNode.removeChild(feedback);
        }
    }, 500);
}

function stopAutoClick() {
    if (autoClickInterval) {
        clearInterval(autoClickInterval);
        autoClickInterval = null;
        console.log('üõë Auto-click system stopped');
    }
}

// ===== COMPREHENSIVE KEEP-AWAKE SYSTEM =====
class KeepAwakeSystem {
    constructor() {
        this.intervals = [];
        this.wakeLock = null;
        this.videoElement = null;
        this.audioContext = null;
    }
    
    start() {
        console.log('üîã Starting comprehensive keep-awake system');
        
        // 1. Start auto-click every 30 seconds
        this.startAutoClickSystem();
        
        // 2. Add keyboard events (Shift key every 45 seconds)
        this.startKeyboardActivity();
        
        // 3. Add visual activity
        this.startVisualActivity();
        
        // 4. Use Wake Lock API if available
        this.startWakeLock();
        
        // 5. Silent video playback (most effective)
        this.startSilentVideo();
        
        // 6. Safe click zones
        this.createSafeClickZones();
        
        console.log('‚úÖ Keep-awake system fully activated');
    }
    
    startAutoClickSystem() {
        // Click every 30 seconds
        const clickInterval = setInterval(() => {
            if (!examInProgress || document.hidden) return;
            performSmartClick();
        }, 30000);
        
        this.intervals.push(clickInterval);
        
        // Do initial click
        setTimeout(() => {
            if (examInProgress) performSmartClick();
        }, 2000);
    }
    
    startKeyboardActivity() {
        // Simulate keyboard activity every 45 seconds
        const keyboardInterval = setInterval(() => {
            if (!examInProgress || document.hidden) return;
            
            try {
                // Simulate Shift key press
                const keyDown = new KeyboardEvent('keydown', {
                    key: 'Shift',
                    code: 'ShiftLeft',
                    keyCode: 16,
                    bubbles: true,
                    cancelable: true
                });
                
                const keyUp = new KeyboardEvent('keyup', {
                    key: 'Shift',
                    code: 'ShiftLeft',
                    keyCode: 16,
                    bubbles: true,
                    cancelable: true
                });
                
                document.dispatchEvent(keyDown);
                setTimeout(() => document.dispatchEvent(keyUp), 100);
                
                console.log('‚å®Ô∏è Simulated keyboard activity');
                
            } catch (error) {
                console.error('Keyboard activity error:', error);
            }
        }, 45000);
        
        this.intervals.push(keyboardInterval);
    }
    
    startVisualActivity() {
        // Change document title slightly (some systems monitor this)
        let titleCounter = 0;
        const originalTitle = document.title;
        
        const titleInterval = setInterval(() => {
            if (!examInProgress) return;
            
            titleCounter++;
            if (titleCounter % 2 === 0) {
                document.title = '‚Ä¢ ' + originalTitle;
            } else {
                document.title = originalTitle;
            }
        }, 25000);
        
        this.intervals.push(titleInterval);
    }
    
    async startWakeLock() {
        try {
            if ('wakeLock' in navigator) {
                this.wakeLock = await navigator.wakeLock.request('screen');
                console.log('‚úÖ Wake Lock acquired');
                
                // Reacquire on visibility change
                document.addEventListener('visibilitychange', async () => {
                    if (document.visibilityState === 'visible' && examInProgress && this.wakeLock === null) {
                        try {
                            this.wakeLock = await navigator.wakeLock.request('screen');
                            console.log('üîÑ Wake lock reacquired');
                        } catch (err) {
                            console.error('Wake lock reacquisition failed:', err);
                        }
                    }
                });
            }
        } catch (err) {
            console.log('Wake Lock not available:', err.message);
        }
    }
    
    startSilentVideo() {
        try {
            // Create a 1x1 pixel video element
            this.videoElement = document.createElement('video');
            this.videoElement.style.cssText = `
                position: absolute;
                width: 1px;
                height: 1px;
                opacity: 0.001;
                pointer-events: none;
                z-index: -9999;
            `;
            
            // Create canvas stream
            const canvas = document.createElement('canvas');
            canvas.width = 2;
            canvas.height = 2;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, 2, 2);
            
            const stream = canvas.captureStream(1); // 1 FPS
            this.videoElement.srcObject = stream;
            this.videoElement.muted = true;
            this.videoElement.autoplay = true;
            this.videoElement.loop = true;
            
            document.body.appendChild(this.videoElement);
            
            // Try to play
            this.videoElement.play().catch(e => {
                console.log('Video play failed:', e);
            });
            
        } catch (error) {
            console.error('Silent video failed:', error);
        }
    }
    
    createSafeClickZones() {
        // Add CSS animation to body
        const style = document.createElement('style');
        style.textContent = `
            @keyframes antiSleepPulse {
                0% { transform: translateY(0); }
                100% { transform: translateY(0.1px); }
            }
            body.anti-sleep-active {
                animation: antiSleepPulse 60s infinite;
            }
            
            .safe-click-zone {
                position: fixed;
                width: 50px;
                height: 50px;
                background: transparent;
                pointer-events: auto;
                cursor: default;
                z-index: 9997;
            }
            .safe-click-zone.top-left { top: 0; left: 0; }
            .safe-click-zone.top-right { top: 0; right: 0; }
            .safe-click-zone.bottom-left { bottom: 0; left: 0; }
            .safe-click-zone.bottom-right { bottom: 0; right: 0; }
        `;
        document.head.appendChild(style);
        
        document.body.classList.add('anti-sleep-active');
        
        // Create safe click zones in corners
        const corners = [
            { className: 'top-left', top: 0, left: 0 },
            { className: 'top-right', top: 0, right: 0 },
            { className: 'bottom-left', bottom: 0, left: 0 },
            { className: 'bottom-right', bottom: 0, right: 0 }
        ];
        
        corners.forEach(corner => {
            const zone = document.createElement('div');
            zone.className = `safe-click-zone ${corner.className}`;
            zone.title = 'Safe click zone (prevents screen sleep)';
            
            zone.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log(`‚úÖ Safe click in ${corner.className} corner`);
            });
            
            document.body.appendChild(zone);
        });
    }
    
    stop() {
        // Clear all intervals
        this.intervals.forEach(interval => clearInterval(interval));
        this.intervals = [];
        
        // Stop auto-click
        stopAutoClick();
        
        // Release wake lock
        if (this.wakeLock) {
            this.wakeLock.release();
            this.wakeLock = null;
        }
        
        // Remove video
        if (this.videoElement) {
            this.videoElement.pause();
            if (this.videoElement.parentNode) {
                this.videoElement.parentNode.removeChild(this.videoElement);
            }
            this.videoElement = null;
        }
        
        // Remove audio context
        if (this.audioContext) {
            this.audioContext.close();
            this.audioContext = null;
        }
        
        // Remove CSS class
        document.body.classList.remove('anti-sleep-active');
        
        // Remove safe click zones
        document.querySelectorAll('.safe-click-zone').forEach(zone => {
            if (zone.parentNode) {
                zone.parentNode.removeChild(zone);
            }
        });
        
        // Reset title
        const originalTitle = document.title.replace(/^‚Ä¢\s*/, '');
        document.title = originalTitle;
        
        console.log('üõë Keep-awake system stopped');
    }
}

// Smart click function
function performSmartClick() {
    if (!examInProgress) return;
    
    try {
        // Strategy: Click on safe zones (corners)
        const safeZones = document.querySelectorAll('.safe-click-zone');
        if (safeZones.length > 0) {
            // Pick a random safe zone
            const randomZone = safeZones[Math.floor(Math.random() * safeZones.length)];
            const rect = randomZone.getBoundingClientRect();
            const x = rect.left + rect.width / 2;
            const y = rect.top + rect.height / 2;
            
            // Dispatch click event
            const clickEvent = new MouseEvent('click', {
                view: window,
                bubbles: true,
                cancelable: true,
                clientX: x,
                clientY: y,
                button: 0
            });
            
            randomZone.dispatchEvent(clickEvent);
            console.log(`üéØ Smart click on safe zone: ${randomZone.className}`);
        } else {
            // Fallback: Click on body
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * window.innerHeight;
            simulateRealClick(x, y);
        }
        
    } catch (error) {
        console.error('Smart click error:', error);
    }
}

// Initialize keep awake system
keepAwakeSystem = new KeepAwakeSystem();

// ===== SYSTEM TRAY & SEARCH BAR SECURITY CLASS =====
class SystemTrayViolationDetector {
    constructor() {
        this.violationCount = 0;
        this.maxViolations = 3;
        this.lastViolationTime = 0;
        this.systemTrayCheckInterval = null;
        console.log('üîí System Tray & Search Bar Security System Initialized');
    }
    
    enable() {
        this.setupDetection();
        this.startPeriodicChecks();
        this.violationCount = 0;
        this.lastViolationTime = 0;
        console.log('‚úÖ System Tray Security Enabled');
        return this;
    }
    
    disable() {
        this.stopPeriodicChecks();
        console.log('üîì System Tray Security Disabled');
    }
    
    setupDetection() {
        // 1. WINDOWS/META KEY DETECTION (Opens Start Menu/Search)
        document.addEventListener('keydown', (e) => {
            if (!examInProgress) return;
            
            const currentTime = Date.now();
            if (currentTime - this.lastViolationTime < 500) return;
            
            // Windows/Command key (Meta key) - Opens Start Menu/Search
            if (e.key === 'Meta' || e.key === 'Win' || e.keyCode === 91 || e.keyCode === 92) {
                e.preventDefault();
                e.stopPropagation();
                this.handleViolation('Windows key pressed (opens Start Menu/Search)');
                return false;
            }
            
            // Windows+S (Windows Search)
            if ((e.key === 's' || e.key === 'S') && (e.metaKey || e.ctrlKey)) {
                e.preventDefault();
                e.stopPropagation();
                this.handleViolation('Windows+S pressed (opens Windows Search)');
                return false;
            }
            
            // Windows+R (Run dialog)
            if ((e.key === 'r' || e.key === 'R') && e.metaKey) {
                e.preventDefault();
                e.stopPropagation();
                this.handleViolation('Windows+R pressed (opens Run dialog)');
                return false;
            }
            
            // Windows+X (Power User menu)
            if ((e.key === 'x' || e.key === 'X') && e.metaKey) {
                e.preventDefault();
                e.stopPropagation();
                this.handleViolation('Windows+X pressed (opens Power User menu)');
                return false;
            }
            
            // Windows+D (Show desktop)
            if ((e.key === 'd' || e.key === 'D') && e.metaKey) {
                e.preventDefault();
                e.stopPropagation();
                this.handleViolation('Windows+D pressed (minimizes all windows)');
                return false;
            }
            
            // Alt+Tab (Task switching)
            if (e.key === 'Tab' && e.altKey) {
                e.preventDefault();
                e.stopPropagation();
                this.handleViolation('Alt+Tab pressed (task switching)');
                return false;
            }
            
            // Windows+Tab (Task View)
            if (e.key === 'Tab' && e.metaKey) {
                e.preventDefault();
                e.stopPropagation();
                this.handleViolation('Windows+Tab pressed (Task View)');
                return false;
            }
        }, true);
    }
    
    startPeriodicChecks() {
        if (this.systemTrayCheckInterval) clearInterval(this.systemTrayCheckInterval);
        
        this.systemTrayCheckInterval = setInterval(() => {
            if (!examInProgress) return;
            
            // Check if window lost focus without tab switch (likely system tray)
            if (!document.hasFocus()) {
                const currentTime = Date.now();
                if (currentTime - lastTabSwitchTime > 3000) {
                    // Window lost focus but no recent tab switch - likely system tray
                    this.handleViolation('Window focus lost to system tray/taskbar');
                }
            }
        }, 1000);
    }
    
    stopPeriodicChecks() {
        if (this.systemTrayCheckInterval) {
            clearInterval(this.systemTrayCheckInterval);
            this.systemTrayCheckInterval = null;
        }
    }
    
    handleViolation(violationType) {
        if (!examInProgress) return;
        
        const currentTime = Date.now();
        
        // Prevent counting multiple violations in rapid succession
        if (currentTime - this.lastViolationTime < 1000) {
            console.log(`Ignoring rapid system tray violation: ${violationType}`);
            return;
        }
        
        this.lastViolationTime = currentTime;
        this.violationCount++;
        
        console.log(`üö® System Tray Violation #${this.violationCount}: ${violationType}`);
        
        // Show warning to student
        this.showWarning(this.violationCount, violationType);
        
        // SUBMIT EXAM AFTER 3 VIOLATIONS (Same as tab switches!)
        if (this.violationCount >= this.maxViolations) {
            console.log('üö® 3 system tray violations detected - submitting exam!');
            
            // Show final warning
            this.showViolationOverlay(`
                üö® EXAM VIOLATION DETECTED
                <br><br>
                ${violationType}
                <br><br>
                <strong>3 system tray violations reached!</strong>
                <br>
                Submitting exam in 3 seconds...
            `, 'red');
            
            // Submit exam after delay
            setTimeout(() => {
                if (examInProgress) {
                    submitExam();
                }
            }, 3000);
        }
    }
    
    showWarning(count, violationType) {
        const messages = [
            `‚ö†Ô∏è System Access: ${violationType} (1/${this.maxViolations})`,
            `‚ö†Ô∏è System Access: ${violationType} (2/${this.maxViolations}) - One more violation will submit exam!`,
            `üö® 3 system tray violations detected! ${violationType} - Submitting exam...`
        ];
        
        const messageIndex = Math.min(count - 1, 2);
        showToast(messages[messageIndex], 'error', 5000);
        
        // Show big warning overlay for serious violations
        if (count >= 2) {
            this.showViolationOverlay(`
                ‚ö†Ô∏è SYSTEM TRAY VIOLATION
                <br><br>
                ${violationType}
                <br><br>
                <strong>Count: ${count}/${this.maxViolations}</strong>
                <br>
                Accessing system tray, taskbar, or Windows shortcuts is prohibited!
            `, 'orange');
        }
    }
    
    showViolationOverlay(message, color) {
        const existingOverlay = document.getElementById('violationWarningOverlay');
        if (existingOverlay) {
            existingOverlay.remove();
        }
        
        const overlay = document.createElement('div');
        overlay.id = 'violationWarningOverlay';
        overlay.style.cssText = `
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: ${color === 'red' ? 'rgba(255, 0, 0, 0.95)' : 'rgba(255, 165, 0, 0.95)'};
            color: white;
            padding: 25px 35px;
            border-radius: 15px;
            z-index: 10002;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            border: 4px solid white;
            box-shadow: 0 0 40px ${color === 'red' ? 'red' : 'orange'};
            animation: pulse 1s infinite;
            max-width: 80%;
            min-width: 300px;
        `;
        
        overlay.innerHTML = message;
        document.body.appendChild(overlay);
        
        setTimeout(() => {
            overlay.style.animation = 'fadeOut 0.5s ease';
            setTimeout(() => {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
            }, 500);
        }, 5000);
    }
    
    reset() {
        this.violationCount = 0;
        this.lastViolationTime = 0;
        console.log('üîÑ System tray violations reset');
    }
}

// ===== LOAD ANSWER KEY FROM EXTERNAL FILE ONLY =====
async function loadAnswerKey() {
    try {
        console.log("üì• LOADING ANSWER KEY FROM EXTERNAL FILE...");
        
        // Load from external file
        const response = await fetch(ANSWER_KEY_URL);
        
        if (!response.ok) {
            throw new Error(`Failed to load answer key: HTTP ${response.status}`);
        }
        
        const text = await response.text();
        answerKey = parseAnswerKeyFile(text);
        
        // Verify we have exactly 75 answers
        if (answerKey.length !== 75) {
            throw new Error(`Expected 75 answers, got ${answerKey.length}. Check the answer-key.txt format.`);
        }
        
        // Validate each answer
        for (let i = 0; i < 75; i++) {
            const qNum = i + 1;
            const answer = answerKey[i];
            
            // Determine question type
            const isNumerical = 
                (qNum >= 21 && qNum <= 25) ||    // Physics numerical
                (qNum >= 46 && qNum <= 50) ||    // Chemistry numerical
                (qNum >= 71 && qNum <= 75);      // Maths numerical
            
            if (isNumerical) {
                if (!/^-?\d+(\.\d+)?$/.test(answer)) {
                    throw new Error(`Invalid numerical answer at Q${qNum}: "${answer}"`);
                }
            } else {
                if (!['A', 'B', 'C', 'D'].includes(answer)) {
                    throw new Error(`Invalid MCQ answer at Q${qNum}: "${answer}"`);
                }
            }
        }
        
        console.log("‚úÖ EXTERNAL ANSWER KEY LOADED SUCCESSFULLY!");
        console.log("üìä Total answers:", answerKey.length);
        console.log("üìã First 10 answers:", answerKey.slice(0, 10));
        console.log("üìã Last 10 answers:", answerKey.slice(65, 75));
        
        keyLoaded = true;
        
        // Initialize images array
        images = [];
        for (let i = 1; i <= 75; i++) {
            images.push(`questions/${i}.png`);
        }
        
        // Preload images
        await preloadAllImages();
        
        showToast('‚úÖ Answer key loaded! Enter access code.', 'success', 3000);
        
        clearErrors();
        validateStudentInputs();
        return true;
        
    } catch (error) {
        console.error("‚ùå ERROR LOADING ANSWER KEY:", error);
        
        showError(`
            <div style="color: red; padding: 15px; border: 2px solid red; border-radius: 5px;">
                <strong>‚ùå ANSWER KEY ERROR</strong><br><br>
                ${error.message}<br><br>
                <small>Please check the answer-key.txt file format and ensure it exists.</small>
            </div>
        `);
        
        document.getElementById('stuStartBtn').style.display = 'none';
        return false;
    }
}

function parseAnswerKeyFile(text) {
    const lines = text.trim().split('\n');
    const answers = [];
    
    for (let line of lines) {
        line = line.trim();
        if (line) {
            // Check if line contains multiple answers (like "BAAAB")
            if (line.length > 1 && /^[A-D]{5}$/.test(line)) {
                // Split combined answers like "BAAAB" into individual letters
                answers.push(...line.split(''));
            } else {
                // Single answer (numerical or single letter)
                answers.push(line);
            }
        }
    }
    
    return answers;
}

// ===== IMAGE HANDLING FUNCTIONS =====
async function preloadAllImages() {
    console.log("üñºÔ∏è Preloading all question images...");
    
    const imagePromises = [];
    
    // Create array of image paths for 75 questions
    for (let i = 1; i <= 75; i++) {
        // Try multiple possible image paths
        const possiblePaths = [
            `questions/${i}.png`,
            `questions/Q${i}.png`,
            `questions/${i}.jpg`,
            `questions/Q${i}.jpg`,
            `questions/${i}.jpeg`,
            `questions/Q${i}.jpeg`,
            `images/${i}.png`,
            `images/Q${i}.png`
        ];
        
        for (const path of possiblePaths) {
            const promise = new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    console.log(`‚úÖ Preloaded: ${path}`);
                    preloadedImages[path] = img;
                    resolve(path);
                };
                img.onerror = () => {
                    console.log(`‚ùå Failed to preload: ${path}`);
                    resolve(null);
                };
                img.src = path;
            });
            imagePromises.push(promise);
        }
    }
    
    await Promise.all(imagePromises);
    console.log("‚úÖ Image preloading complete");
}

function getBestImagePath(questionNumber) {
    // Try multiple possible paths
    const possiblePaths = [
        `questions/${questionNumber}.png`,
        `questions/Q${questionNumber}.png`,
        `questions/${questionNumber}.jpg`,
        `questions/Q${questionNumber}.jpg`,
        `questions/${questionNumber}.jpeg`,
        `questions/Q${questionNumber}.jpeg`,
        `images/${questionNumber}.png`,
        `images/Q${questionNumber}.png`,
        `images/${questionNumber}.jpg`,
        `images/Q${questionNumber}.jpg`
    ];
    
    // Check which image is actually available
    for (const path of possiblePaths) {
        if (preloadedImages[path]) {
            return path;
        }
    }
    
    // Return default path
    return `questions/${questionNumber}.png`;
}

function renderImageContainer(imagePath, questionNumber) {
    // Check if image is preloaded
    const preloadedImg = preloadedImages[imagePath];
    
    if (preloadedImg) {
        return `
            <div class="question-image-container">
                <img src="${imagePath}" 
                     class="question-image" 
                     alt="Question ${questionNumber}"
                     style="max-width: 100%; max-height: 500px; object-fit: contain;">
            </div>
        `;
    } else {
        // Try to load image with error handling
        return `
            <div class="question-image-container">
                <img src="${imagePath}" 
                     class="question-image" 
                     alt="Question ${questionNumber}"
                     onload="console.log('‚úÖ Image loaded successfully: ${imagePath}')"
                     onerror="handleImageError(this, ${questionNumber})"
                     style="max-width: 100%; max-height: 500px; object-fit: contain;">
            </div>
        `;
    }
}

function handleImageError(imgElement, questionNumber) {
    console.error(`‚ùå Image failed to load: ${imgElement.src}`);
    
    const container = imgElement.closest('.question-image-container');
    if (container) {
        container.innerHTML = `
            <div class="image-fallback">
                <h3>‚ö†Ô∏è Question Image Not Available</h3>
                <p>Question ${questionNumber}</p>
                <p style="margin-top: 20px; font-size: 14px;">
                    Please refer to your question paper or contact the exam administrator.
                </p>
                <div style="margin-top: 20px;">
                    <button onclick="retryImageLoad(${questionNumber})" 
                            style="padding: 8px 16px; background: #4B0082; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Retry Loading
                    </button>
                </div>
            </div>
        `;
    }
}

function retryImageLoad(questionNumber) {
    const idx = progress.currentIndex;
    const originalIndex = examData.originalOrder[idx] + 1;
    
    // Try alternative image paths
    const alternativePaths = [
        `questions/${originalIndex}.png`,
        `questions/Q${originalIndex}.png`,
        `questions/${originalIndex}.jpg`,
        `questions/Q${originalIndex}.jpg`,
        `images/${originalIndex}.png`,
        `images/Q${originalIndex}.png`
    ];
    
    let retryCount = 0;
    const maxRetries = alternativePaths.length;
    
    function tryNextPath() {
        if (retryCount >= maxRetries) {
            console.error(`‚ùå All image paths failed for question ${originalIndex}`);
            return;
        }
        
        const path = alternativePaths[retryCount];
        console.log(`üîÑ Retrying image ${retryCount + 1}/${maxRetries}: ${path}`);
        
        const img = new Image();
        img.onload = function() {
            console.log(`‚úÖ Retry successful: ${path}`);
            // Update the image in the container
            const container = document.querySelector('.question-image-container');
            if (container) {
                container.innerHTML = `
                    <img src="${path}" 
                         class="question-image" 
                         alt="Question ${questionNumber}"
                         style="max-width: 100%; max-height: 500px; object-fit: contain;">
                `;
            }
        };
        img.onerror = function() {
            console.log(`‚ùå Retry failed: ${path}`);
            retryCount++;
            setTimeout(tryNextPath, 500);
        };
        img.src = path;
    }
    
    tryNextPath();
}

// ===== POWER LOSS PROTECTION SYSTEM =====
function initPowerLossProtection() {
    console.log('‚ö° Initializing Power Loss Protection System');
    
    // Create connection status element
    createConnectionStatusElement();
    
    // Create auto-save indicator
    createAutoSaveIndicator();
    
    // Setup event listeners
    setupPowerLossEventListeners();
    
    // Check for recovery on page load
    setTimeout(() => checkForPowerLossRecovery(), 1000);
    
    // Start auto-save timer
    startAutoSaveTimer();
    
    console.log('‚úÖ Power Loss Protection System Ready');
}

function createConnectionStatusElement() {
    connectionStatusElement = document.createElement('div');
    connectionStatusElement.id = 'connectionStatus';
    connectionStatusElement.innerHTML = `
        <span style="color:#32CD32; font-size:16px;">‚óè</span>
        <span>Online</span>
    `;
    document.body.appendChild(connectionStatusElement);
    updateConnectionStatus(navigator.onLine);
}

function createAutoSaveIndicator() {
    autoSaveIndicator = document.getElementById('autoSaveIndicator');
    if (!autoSaveIndicator) {
        autoSaveIndicator = document.createElement('div');
        autoSaveIndicator.id = 'autoSaveIndicator';
        autoSaveIndicator.textContent = 'Auto-saved ‚úì';
        document.body.appendChild(autoSaveIndicator);
    }
}

function setupPowerLossEventListeners() {
    // Online/offline detection
    window.addEventListener('online', () => {
        updateConnectionStatus(true);
        showToast('‚úÖ Internet connection restored', 'success', 3000);
        syncPendingSubmissions();
    });
    
    window.addEventListener('offline', () => {
        updateConnectionStatus(false);
        showToast('‚ö†Ô∏è Internet connection lost. Working offline...', 'warning', 5000);
        forceSaveProgress();
    });
    
    // Beforeunload (browser/tab close)
    window.addEventListener('beforeunload', (e) => {
        if (examInProgress) {
            forceSaveProgress();
            // Optional: Show warning
            e.preventDefault();
            e.returnValue = 'Your exam progress is being saved. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
    
    // Visibility change (tab switch/minimize)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden && examInProgress) {
            saveExamProgress();
        }
    });
}

function updateConnectionStatus(isOnline) {
    if (!connectionStatusElement) return;
    
    if (isOnline) {
        connectionStatusElement.innerHTML = `
            <span style="color:#32CD32; font-size:16px;">‚óè</span>
            <span>Online</span>
        `;
        connectionStatusElement.style.borderLeftColor = '#32CD32';
        connectionStatusElement.title = 'Connected to internet';
    } else {
        connectionStatusElement.innerHTML = `
            <span style="color:#FF6B6B; font-size:16px;">‚óè</span>
            <span>Offline - Answers saved locally</span>
        `;
        connectionStatusElement.style.borderLeftColor = '#FF6B6B';
        connectionStatusElement.title = 'No internet connection. Answers are being saved locally.';
    }
}

function startAutoSaveTimer() {
    if (autoSaveTimer) clearInterval(autoSaveTimer);
    
    autoSaveTimer = setInterval(() => {
        if (examInProgress && progress) {
            saveExamProgress();
            showAutoSaveIndicator();
        }
    }, AUTO_SAVE_INTERVAL * 1000);
}

function showAutoSaveIndicator() {
    if (!autoSaveIndicator) return;
    
    autoSaveIndicator.classList.add('show');
    setTimeout(() => {
        autoSaveIndicator.classList.remove('show');
    }, 2000);
}

function saveExamProgress() {
    if (!examInProgress || !progress) return;
    
    try {
        const saveData = {
            progress: {
                answers: [...progress.answers],
                review: [...progress.review],
                currentIndex: progress.currentIndex,
                timeLeftSec: progress.timeLeftSec,
                student: { ...progress.student }
            },
            
            examData: {
                files: [...examData.files],
                subjectNames: [...examData.subjectNames],
                keys: [...examData.keys],
                originalOrder: [...examData.originalOrder],
                questionTypes: [...examData.questionTypes]
            },
            
            metadata: {
                examStartTime: examStartTime,
                assignedForm: assignedForm,
                examId: generateExamId(),
                timestamp: Date.now(),
                version: '2.0'
            }
        };
        
        // MULTIPLE REDUNDANT SAVES
        localStorage.setItem(STORAGE_KEYS.EXAM_PROGRESS, JSON.stringify(saveData));
        localStorage.setItem(STORAGE_KEYS.ANSWERS_BACKUP, JSON.stringify(progress.answers));
        localStorage.setItem(STORAGE_KEYS.EXAM_STATE, JSON.stringify({
            timestamp: Date.now(),
            currentIndex: progress.currentIndex,
            timeLeft: progress.timeLeftSec,
            student: progress.student.name
        }));
        localStorage.setItem(STORAGE_KEYS.LAST_SAVE_TIME, Date.now().toString());
        
        console.log('üíæ Exam progress saved');
        
    } catch (error) {
        console.error('‚ùå Auto-save failed:', error);
        saveEmergencyBackup();
    }
}

function saveEmergencyBackup() {
    try {
        const emergencyData = {
            answers: progress ? progress.answers : [],
            timestamp: Date.now(),
            student: progress ? progress.student.name : 'Unknown'
        };
        
        sessionStorage.setItem('exam_emergency_backup', JSON.stringify(emergencyData));
        
    } catch (e) {
        console.error('‚ùå Emergency backup failed');
    }
}

function forceSaveProgress() {
    if (examInProgress) {
        saveExamProgress();
        showToast('üíæ Progress saved locally', 'info', 2000);
    }
}

function checkForPowerLossRecovery() {
    try {
        const savedProgress = localStorage.getItem(STORAGE_KEYS.EXAM_PROGRESS);
        if (!savedProgress) {
            // Also check for resume exam in student entry
            checkResumeExam();
            return;
        }
        
        const progressData = JSON.parse(savedProgress);
        const lastSaveTime = parseInt(localStorage.getItem(STORAGE_KEYS.LAST_SAVE_TIME) || '0');
        const hoursSinceSave = (Date.now() - lastSaveTime) / (1000 * 60 * 60);
        
        if (hoursSinceSave < RECOVERY_WINDOW_HOURS) {
            powerLossRecoveryData = progressData;
            showPowerLossRecoveryDialog(progressData, lastSaveTime);
        } else {
            clearSavedExam();
            checkResumeExam();
        }
        
    } catch (error) {
        console.error('‚ùå Power loss recovery check failed:', error);
        checkResumeExam();
    }
}

function showPowerLossRecoveryDialog(progressData, lastSaveTime) {
    const recoveryOverlay = document.getElementById('powerLossRecoveryOverlay');
    if (!recoveryOverlay) return;
    
    const studentName = progressData.progress.student.name;
    const answeredQuestions = progressData.progress.answers.filter(a => a !== null).length;
    const totalQuestions = progressData.progress.answers.length;
    const recoveryTime = new Date(lastSaveTime).toLocaleTimeString();
    const timeLeft = progressData.progress.timeLeftSec;
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    
    document.getElementById('recoveryStudentName').innerHTML = `<strong>Student:</strong> ${studentName}`;
    document.getElementById('recoveryLastSave').innerHTML = `<strong>Last Save:</strong> ${recoveryTime}`;
    document.getElementById('recoveryProgress').innerHTML = `<strong>Progress:</strong> ${answeredQuestions}/${totalQuestions} questions answered`;
    document.getElementById('recoveryTimeLeft').innerHTML = `<strong>Time Remaining:</strong> ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const progressPercent = Math.round((answeredQuestions / totalQuestions) * 100);
    document.getElementById('recoveryProgressBar').style.width = `${progressPercent}%`;
    document.getElementById('recoveryStatus').textContent = `${progressPercent}% completed`;
    
    recoveryOverlay.style.display = 'flex';
    
    document.getElementById('resumeExamRecoveryBtn').onclick = () => resumeFromPowerLoss(progressData);
    document.getElementById('discardExamRecoveryBtn').onclick = discardPowerLossRecovery;
}

function resumeFromPowerLoss(progressData) {
    console.log('üîÑ Resuming exam from power loss recovery...');
    
    // Hide recovery overlay
    document.getElementById('powerLossRecoveryOverlay').style.display = 'none';
    
    // Hide access denied screen if visible
    document.getElementById('accessDenied').style.display = 'none';
    
    // Show student entry screen
    document.getElementById('studentEntry').style.display = 'flex';
    
    // Auto-fill student information from saved progress
    const student = progressData.progress.student;
    document.getElementById('stuName').value = student.name || '';
    document.getElementById('stuSection').value = student.sec || '';
    document.getElementById('stuRoll').value = student.roll || '';
    document.getElementById('stuAdm').value = student.adm || '';
    
    // Hide the resume section (we're already resuming)
    document.getElementById('resumeExamSection').style.display = 'none';
    
    // Store recovery data globally
    window.pendingRecoveryData = progressData;
    
    // Show start button and modify it for resume
    document.getElementById('stuStartBtn').style.display = 'inline-block';
    
    // Change start button text
    const startBtn = document.getElementById('stuStartBtn');
    startBtn.textContent = 'Continue Exam';
    
    // Store original click handler
    const originalClick = startBtn.onclick;
    
    // Override click handler for resume
    startBtn.onclick = function() {
        if (validateStudentInputs()) {
            startExamWithRecovery(progressData);
        }
    };
    
    // Validate to show start button
    validateStudentInputs();
    
    showToast('‚úÖ Recovery data loaded. Click "Continue Exam" to resume.', 'success', 5000);
}

function startExamWithRecovery(progressData) {
    console.log('üöÄ Starting exam with recovery data...');
    
    // Use the recovery data
    progress = progressData.progress;
    examData = progressData.examData;
    examStartTime = progressData.metadata.examStartTime;
    assignedForm = progressData.metadata.assignedForm;
    examInProgress = true;
    
    // Calculate adjusted time based on elapsed time
    const timeElapsed = Math.floor((Date.now() - examStartTime) / 1000);
    progress.timeLeftSec = Math.max(0, EXAM_DURATION_MINUTES * 60 - timeElapsed);
    
    // Hide student entry and show exam area
    document.getElementById('studentEntry').style.display = 'none';
    document.getElementById('examArea').style.display = 'block';
    
    // Initialize exam
    renderQuestion();
    renderPalette();
    startTimer();
    updateNavButtons();
    
    // Start keep-awake system
    keepAwakeSystem.start();
    
    // Enable all security systems
    examSecurity.enable();
    systemTrayDetector.enable();
    
    showToast('‚úÖ Exam resumed from saved progress', 'success', 4000);
    
    // Save progress immediately
    saveExamProgress();
}

function discardPowerLossRecovery() {
    if (confirm('Are you sure you want to discard the saved exam and start fresh?')) {
        clearSavedExam();
        document.getElementById('powerLossRecoveryOverlay').style.display = 'none';
        showToast('üóëÔ∏è Saved exam discarded', 'info', 3000);
        // Show student entry for fresh start
        document.getElementById('accessDenied').style.display = 'none';
        document.getElementById('studentEntry').style.display = 'flex';
    }
}

function checkResumeExam() {
    try {
        const savedProgress = localStorage.getItem(STORAGE_KEYS.EXAM_PROGRESS);
        if (!savedProgress) return;
        
        const progressData = JSON.parse(savedProgress);
        const lastSaveTime = parseInt(localStorage.getItem(STORAGE_KEYS.LAST_SAVE_TIME) || '0');
        const hoursSinceSave = (Date.now() - lastSaveTime) / (1000 * 60 * 60);
        
        if (hoursSinceSave < RECOVERY_WINDOW_HOURS) {
            // Show resume section in student entry
            document.getElementById('resumeExamSection').style.display = 'block';
            
            // Fill resume info
            const student = progressData.progress.student;
            const answeredQuestions = progressData.progress.answers.filter(a => a !== null).length;
            const totalQuestions = progressData.progress.answers.length;
            const timeLeft = progressData.progress.timeLeftSec;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            
            document.getElementById('resumeStudentName').textContent = student.name;
            document.getElementById('resumeSection').textContent = student.sec;
            document.getElementById('resumeProgress').textContent = `${answeredQuestions}/${totalQuestions} questions`;
            document.getElementById('resumeTimeLeft').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Setup resume button
            document.getElementById('resumeExamBtn').onclick = function() {
                resumeFromPowerLoss(progressData);
            };
            
            // Setup start new button
            document.getElementById('startNewBtn').onclick = function() {
                if (confirm('Are you sure you want to start a new exam? The current progress will be lost.')) {
                    clearSavedExam();
                    document.getElementById('resumeExamSection').style.display = 'none';
                    document.getElementById('stuName').value = '';
                    document.getElementById('stuSection').value = '';
                    document.getElementById('stuRoll').value = '';
                    document.getElementById('stuAdm').value = '';
                    document.getElementById('stuName').focus();
                    showToast('üóëÔ∏è Previous exam cleared', 'info', 3000);
                }
            };
        }
    } catch (error) {
        console.error('Error checking resume exam:', error);
    }
}

function clearSavedExam() {
    Object.values(STORAGE_KEYS).forEach(key => {
        localStorage.removeItem(key);
    });
    sessionStorage.removeItem('exam_emergency_backup');
    window.pendingRecoveryData = null;
}

function syncPendingSubmissions() {
    if (!navigator.onLine) return;
    
    try {
        const pendingSubmissions = JSON.parse(localStorage.getItem(STORAGE_KEYS.PENDING_SUBMISSIONS) || '[]');
        if (pendingSubmissions.length === 0) return;
        
        console.log(`üîÑ Syncing ${pendingSubmissions.length} pending submissions`);
        
        pendingSubmissions.forEach((submission, index) => {
            setTimeout(() => {
                console.log(`üì§ Syncing submission ${index + 1} for ${submission.student.name}`);
                pendingSubmissions.splice(index, 1);
                localStorage.setItem(STORAGE_KEYS.PENDING_SUBMISSIONS, JSON.stringify(pendingSubmissions));
            }, index * 1000);
        });
        
        if (pendingSubmissions.length > 0) {
            showToast(`üîÑ Syncing ${pendingSubmissions.length} saved submissions`, 'info', 4000);
        }
        
    } catch (error) {
        console.error('Error syncing pending submissions:', error);
    }
}

// ===== TOAST NOTIFICATION FUNCTION =====
function showToast(message, type = 'info', duration = 3000) {
    const existingToasts = document.querySelectorAll('.toast');
    existingToasts.forEach(toast => {
        toast.style.animation = 'toastSlideOut 0.3s ease';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    });
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        animation: toastSlideIn 0.3s ease;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        font-size: 16px;
        min-width: 300px;
        text-align: center;
    `;
    
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'toastSlideOut 0.3s ease';
        setTimeout(() => {
            if (toast.parentNode) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, duration);
}

// ===== TAB SWITCH WARNING FUNCTION =====
function showTabSwitchWarning(count) {
    const existingWarning = document.querySelector('.tab-switch-warning');
    if (existingWarning) {
        existingWarning.style.animation = 'slideUp 0.5s ease';
        setTimeout(() => {
            if (existingWarning.parentNode) {
                existingWarning.parentNode.removeChild(existingWarning);
            }
        }, 500);
    }
    
    let message = '';
    if (count === 1) {
        message = '‚ö†Ô∏è Warning: Tab switching detected (1/3).';
    } else if (count === 2) {
        message = '‚ö†Ô∏è Warning: Tab switching detected (2/3). One more switch will submit exam!';
    } else if (count >= 3) {
        message = 'üö® 3 tab switches detected! Submitting exam in 3 seconds...';
    }
    
    const warningDiv = document.createElement('div');
    warningDiv.className = 'tab-switch-warning';
    warningDiv.style.cssText = `
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(145deg, #FFA500, #FF8C00);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        font-weight: bold;
        z-index: 10001;
        text-align: center;
        box-shadow: 0 5px 20px rgba(255, 165, 0, 0.3);
        animation: slideDown 0.5s ease;
        font-size: 18px;
        min-width: 350px;
        max-width: 80%;
        border: 2px solid #ff8c00;
    `;
    
    warningDiv.textContent = message;
    document.body.appendChild(warningDiv);
    
    if (count < 3) {
        setTimeout(() => {
            warningDiv.style.animation = 'slideUp 0.5s ease';
            setTimeout(() => {
                if (warningDiv.parentNode) {
                    document.body.removeChild(warningDiv);
                }
            }, 500);
        }, 5000);
    }
    
    if (count >= 3) {
        showToast('üö® 3 tab switches detected! Exam will be submitted in 3 seconds.', 'error', 3000);
    }
}

// ===== SIMPLIFIED FULL-SCREEN SECURITY SYSTEM =====
class FullScreenSecurity {
    constructor() {
        this.isFullScreen = false;
        this.securityActive = false;
        this.retryInterval = null;
        this.maxRetryAttempts = 3;
        this.retryCount = 0;
        this.createWarningOverlay();
    }
    
    createWarningOverlay() {
        this.warningOverlay = document.createElement('div');
        this.warningOverlay.id = 'fullscreen-warning-overlay';
        this.warningOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 2147483646;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
        `;
        
        this.warningOverlay.innerHTML = `
            <div class="warning-content" style="
                background: rgba(255, 0, 0, 0.2);
                padding: 40px;
                border-radius: 20px;
                border: 3px solid rgba(255, 0, 0, 0.5);
                max-width: 500px;
                width: 90%;
                backdrop-filter: blur(10px);
            ">
                <h2 style="color: #ff6b6b; font-size: 28px; margin-bottom: 15px;">
                    ‚ö†Ô∏è FULL-SCREEN REQUIRED
                </h2>
                <p style="font-size: 18px; margin-bottom: 25px; line-height: 1.5;">
                    You have exited full-screen mode. Please return to full-screen to continue the exam.
                </p>
                <button id="enter-fullscreen-btn" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 15px 40px;
                    font-size: 18px;
                    border-radius: 25px;
                    cursor: pointer;
                    font-weight: bold;
                    transition: all 0.3s ease;
                    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
                ">
                    Enter Full-Screen Mode
                </button>
                <p style="margin-top: 20px; color: #aaa; font-size: 14px;">
                    Screen will be un-blurred only after entering full-screen
                </p>
            </div>
        `;
        
        document.body.appendChild(this.warningOverlay);
        
        document.getElementById('enter-fullscreen-btn').addEventListener('click', () => {
            this.enterFullScreen();
        });
    }
    
    async enable() {
        console.log('üîí Enabling full-screen security...');
        this.securityActive = true;
        this.setupEventListeners();
        await this.enterFullScreen();
        console.log('‚úÖ Full-screen security enabled');
    }
    
    async enterFullScreen() {
        try {
            const elem = document.documentElement;
            
            if (elem.requestFullscreen) {
                await elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                await elem.webkitRequestFullscreen();
            } else if (elem.mozRequestFullScreen) {
                await elem.mozRequestFullScreen();
            } else if (elem.msRequestFullscreen) {
                await elem.msRequestFullscreen();
            }
            
            this.isFullScreen = true;
            this.retryCount = 0;
            this.hideWarning();
            console.log('‚úÖ Entered full-screen mode');
            
        } catch (err) {
            console.error('‚ùå Failed to enter full-screen:', err);
            this.showWarning();
        }
    }

    setupEventListeners() {
        document.addEventListener('fullscreenchange', () => this.handleFullscreenChange());
        document.addEventListener('webkitfullscreenchange', () => this.handleFullscreenChange());
        document.addEventListener('mozfullscreenchange', () => this.handleFullscreenChange());
        document.addEventListener('MSFullscreenChange', () => this.handleFullscreenChange());
        
        document.addEventListener('keydown', (e) => this.handleKeyDown(e));
    }
    
    handleFullscreenChange() {
        const isFs = document.fullscreenElement || 
                     document.webkitFullscreenElement || 
                     document.mozFullScreenElement || 
                     document.msFullscreenElement;
        
        this.isFullScreen = !!isFs;
        
        if (!isFs && this.securityActive && examInProgress) {
            this.showWarning();
        } else if (isFs) {
            this.hideWarning();
        }
    }
    
    showWarning() {
        if (this.warningOverlay) {
            this.warningOverlay.style.display = 'flex';
        }
    }
    
    hideWarning() {
        if (this.warningOverlay) {
            this.warningOverlay.style.display = 'none';
        }
    }
    
    handleKeyDown(e) {
        if (this.securityActive && examInProgress && e.key === 'Escape') {
            console.log('üîí Escape key pressed');
            e.preventDefault();
            e.stopPropagation();
        }
        
        if (e.key === 'PrintScreen' || (e.ctrlKey && e.key === 'p')) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
    }
    
    disable() {
        this.securityActive = false;
        
        if (this.retryInterval) {
            clearInterval(this.retryInterval);
        }
        
        this.hideWarning();
        
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        
        console.log('üîì Security system disabled');
    }
}

const examSecurity = new FullScreenSecurity();

// ===== TAB SWITCH DETECTION =====
document.addEventListener('visibilitychange', function() {
    if (document.hidden && examInProgress) {
        const currentTime = Date.now();
        
        if (currentTime - lastTabSwitchTime < 1000) {
            return;
        }
        
        lastTabSwitchTime = currentTime;
        tabSwitchCount++;
        
        console.log(`Tab switch detected: ${tabSwitchCount}/3`);
        showTabSwitchWarning(tabSwitchCount);
        
        // Also check if this might be a system tray click
        if (currentTime - lastTabSwitchTime > 2000) {
            // More than 2 seconds since last tab switch - could be system tray
            systemTrayDetector.handleViolation('Possible system tray/taskbar click');
        }
        
        if (tabSwitchCount >= 3) {
            console.log('üö® 3 tab switches detected - submitting exam');
            setTimeout(() => {
                if (examInProgress) {
                    submitExam();
                }
            }, 3000);
        }
    }
});

// ===== NUMERICAL INPUT HANDLING FUNCTIONS =====
function handleNumericalInput(inputElement, questionIndex) {
  const value = inputElement.value;
  const cleanedValue = value.replace(/[^0-9\.\-]/g, '');
  
  const decimalCount = (cleanedValue.match(/\./g) || []).length;
  if (decimalCount > 1) {
    const parts = cleanedValue.split('.');
    inputElement.value = parts[0] + '.' + parts.slice(1).join('');
  } else if (cleanedValue !== value) {
    inputElement.value = cleanedValue;
  }
  
  setTimeout(() => {
    if (examInProgress) {
      saveExamProgress();
    }
  }, 500);
}

function handleNumericalKeyPress(event, questionIndex) {
  const allowedKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '-', 'Enter', 'Backspace', 'Delete', 'Tab'];
  
  if (!allowedKeys.includes(event.key) && !event.ctrlKey && !event.altKey && !event.metaKey) {
    event.preventDefault();
    return;
  }
  
  if (event.key === 'Enter') {
    submitNumericalAnswer(questionIndex);
    event.preventDefault();
  }
}

function handleKeypadButton(button, questionIndex) {
  const input = document.getElementById('fillBlankInput');
  if (!input) return;
  
  let currentValue = input.value;
  
  switch(button) {
    case 'C':
      input.value = '';
      break;
    case '‚úì':
      submitNumericalAnswer(questionIndex);
      break;
    default:
      input.value = currentValue + button;
      break;
  }
  
  input.focus();
}

function submitNumericalAnswer(questionIndex) {
  const input = document.getElementById('fillBlankInput');
  if (!input) return;
  
  const answer = input.value.trim();
  
  if (answer === '') {
    showToast('Please enter a numerical answer', 'warning', 2000);
    return;
  }
  
  if (!/^-?\d+(\.\d+)?$/.test(answer)) {
    showToast('Please enter a valid number', 'error', 2000);
    return;
  }
  
  progress.answers[questionIndex] = answer;
  showToast('‚úì Answer submitted!', 'success', 2000);
  updatePalette();
  saveExamProgress();
  
  setTimeout(() => {
    if (questionIndex < examData.files.length - 1) {
      progress.currentIndex++;
      renderQuestion();
      updateNavButtons();
    }
  }, 1500);
}

// ===== GOOGLE FORMS FUNCTIONS =====
function getFormFields(section) {
    return {
        ...COMMON_FIELDS,
        ALL_ANSWERS: ANSWERS_FIELDS[section]
    };
}

function getAssignedForm(studentData) {
    const forms = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
    
    if (studentData.roll && !isNaN(studentData.roll)) {
        const rollNumber = parseInt(studentData.roll);
        const formIndex = (rollNumber - 1) % forms.length;
        return forms[formIndex];
    }
    
    const hashString = `${studentData.name}|${studentData.roll}|${studentData.adm}`;
    let hash = 0;
    for (let i = 0; i < hashString.length; i++) {
        hash = ((hash << 5) - hash) + hashString.charCodeAt(i);
        hash = hash & hash;
    }
    return forms[Math.abs(hash) % forms.length];
}

// ===== PREPARE EXAM DATA =====
function prepareExamData() {
  examData.files = []; examData.subjectNames = []; examData.keys = []; examData.originalOrder = []; examData.questionTypes = [];
  
  const subjectRanges = [
    { name: "Physics", start: 1, end: 25 },
    { name: "Chemistry", start: 26, end: 50 },
    { name: "Maths", start: 51, end: 75 }
  ];
  
  let groups = [];
  
  subjectRanges.forEach(subject => {
    const subjectQuestions = [];
    const subjectKeys = [];
    const subjectOriginalOrder = [];
    const subjectTypes = [];
    
    for (let i = subject.start; i <= subject.end; i++) {
      const imgIndex = i - 1;
      if (images[imgIndex] && answerKey[imgIndex]) {
        subjectQuestions.push(images[imgIndex]);
        subjectKeys.push(answerKey[imgIndex]);
        subjectOriginalOrder.push(imgIndex);
        
        let questionType = 'mcq';
        if ((subject.name === "Physics" && i >= 21 && i <= 25) ||
            (subject.name === "Chemistry" && i >= 46 && i <= 50) ||
            (subject.name === "Maths" && i >= 71 && i <= 75)) {
          questionType = 'fill-blank';
        }
        subjectTypes.push(questionType);
      }
    }
    
    const shuffledIndices = shuffleArray([...Array(subjectQuestions.length).keys()]);
    
    groups.push({
      name: subject.name,
      imgs: shuffledIndices.map(i => subjectQuestions[i]),
      keys: shuffledIndices.map(i => subjectKeys[i]),
      originalOrder: shuffledIndices.map(i => subjectOriginalOrder[i]),
      types: shuffledIndices.map(i => subjectTypes[i])
    });
  });
  
  const shuffledGroups = shuffleArray(groups);
  
  shuffledGroups.forEach(g => {
    g.imgs.forEach((img, i) => {
      examData.files.push(img);
      examData.keys.push(g.keys[i]);
      examData.subjectNames.push(g.name);
      examData.originalOrder.push(g.originalOrder[i]);
      examData.questionTypes.push(g.types[i]);
    });
  });
  
  console.log("üéØ EXAM DATA VERIFICATION:");
  console.log("Total Questions:", examData.files.length);
  console.log("Subject distribution:");
  console.log("- Physics:", examData.subjectNames.filter(s => s === "Physics").length);
  console.log("- Chemistry:", examData.subjectNames.filter(s => s === "Chemistry").length);
  console.log("- Maths:", examData.subjectNames.filter(s => s === "Maths").length);
}

// ===== FIXED: RENDER QUESTION WITHOUT DUPLICATE INFO =====
function renderQuestion() {
  const idx = progress.currentIndex;
  const container = document.getElementById('questionContainer');
  
  const originalIndex = examData.originalOrder[idx] + 1;
  const imagePath = getBestImagePath(originalIndex);
  const questionType = examData.questionTypes[idx];
  
  console.log(`üñºÔ∏è Loading: ${imagePath} (Question ${originalIndex}/75) - ${examData.subjectNames[idx]} - ${questionType}`);
  
  let optionsHTML = '';
  
  if (questionType === 'fill-blank') {
    optionsHTML = `
      <div class="fill-blank-container">
        <div style="margin: 20px 0; font-weight: bold; color: #4B0082; font-size: 18px;">
          Enter numerical answer:
        </div>
        <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin: 25px 0;">
          <input type="number" 
                 id="fillBlankInput" 
                 class="fill-blank-input"
                 placeholder="Enter number"
                 value="${progress.answers[idx] || ''}"
                 min="0"
                 step="any"
                 style="
                   padding: 12px 18px;
                   font-size: 22px;
                   border: 2px solid #4B0082;
                   border-radius: 8px;
                   width: 200px;
                   text-align: center;
                   outline: none;
                   font-weight: bold;
                 "
                 oninput="handleNumericalInput(this, ${idx})"
                 onkeypress="handleNumericalKeyPress(event, ${idx})"
                 tabindex="0">
          <button class="submit-fill-blank-btn" 
                  onclick="submitNumericalAnswer(${idx})"
                  tabindex="0"
                  style="
                    padding: 12px 24px;
                    background: linear-gradient(145deg, #32CD32, #228B22);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                  ">
            Submit
          </button>
        </div>
        
        <!-- Numerical Keypad -->
        <div class="numerical-keypad">
          <div class="keypad-grid">
            ${[1,2,3,4,5,6,7,8,9].map(num => `
              <button class="num-key-btn" 
                      onclick="handleKeypadButton('${num}', ${idx})"
                      tabindex="0">
                ${num}
              </button>
            `).join('')}
            <button class="num-key-btn special-btn" 
                    onclick="handleKeypadButton('0', ${idx})"
                    tabindex="0">
              0
            </button>
            <button class="num-key-btn special-btn clear-btn" 
                    onclick="handleKeypadButton('C', ${idx})"
                    tabindex="0">
              C
            </button>
            <button class="num-key-btn special-btn submit-num-btn" 
                    onclick="handleKeypadButton('‚úì', ${idx})"
                    tabindex="0">
              ‚úì
            </button>
          </div>
        </div>
      </div>
    `;
  } else {
    optionsHTML = `
      <div class="options-container">
        <button class="optBtn ${progress.answers[idx] === 'A' ? 'selected' : ''}" data-opt="A" tabindex="0">A</button>
        <button class="optBtn ${progress.answers[idx] === 'B' ? 'selected' : ''}" data-opt="B" tabindex="0">B</button>
        <button class="optBtn ${progress.answers[idx] === 'C' ? 'selected' : ''}" data-opt="C" tabindex="0">C</button>
        <button class="optBtn ${progress.answers[idx] === 'D' ? 'selected' : ''}" data-opt="D" tabindex="0">D</button>
      </div>
    `;
  }
  
  // FIXED: Removed duplicate question number and subject display
  // Only shows image and options
  container.innerHTML = `
    <div class="question-transition question-fade-in">
      ${renderImageContainer(imagePath, originalIndex)}
      ${optionsHTML}
    </div>
  `;
  
  // Update header with question info (shows it once in header)
  updateQuestionInfo();
  
  if (questionType !== 'fill-blank') {
    document.querySelectorAll('.optBtn').forEach(btn => {
      btn.onclick = function() { 
        selectOption(this.getAttribute('data-opt')); 
      };
    });
  } else {
    setTimeout(() => {
      const input = document.getElementById('fillBlankInput');
      if (input) input.focus();
    }, 100);
  }
  
  updatePalette();
}

function selectOption(opt) {
    const idx = progress.currentIndex;
    
    if (progress.answers[idx] === opt) {
        progress.answers[idx] = null;
        console.log(`Deselected option ${opt} for question ${idx + 1}`);
    } else {
        progress.answers[idx] = opt;
        console.log(`Selected option ${opt} for question ${idx + 1}`);
    }
    
    updateOptionButtons();
    updatePalette();
    
    // Auto-save on answer change
    if (examInProgress) {
        setTimeout(() => saveExamProgress(), 500);
    }
}

function updateOptionButtons() {
    const idx = progress.currentIndex;
    const currentAnswer = progress.answers[idx];
    
    document.querySelectorAll('.optBtn').forEach(btn => {
        const btnOpt = btn.getAttribute('data-opt');
        btn.classList.toggle('selected', btnOpt === currentAnswer);
    });
}

// ===== INPUT VALIDATION =====
function validateStudentInputs() {
  const n = document.getElementById('stuName'), 
        s = document.getElementById('stuSection'), 
        r = document.getElementById('stuRoll'), 
        a = document.getElementById('stuAdm');
  
  if (s.value) s.value = s.value.toUpperCase();
  
  let v1 = /^[A-Za-z .]+$/.test(n.value), 
      v2 = /^[A-Za-z0-9]+$/.test(s.value),
      v3 = /^[0-9]+$/.test(r.value), 
      v4 = /^[0-9]+$/.test(a.value);
  
  n.classList.toggle('error', !v1 && n.value !== ""); 
  s.classList.toggle('error', !v2 && s.value !== "");
  r.classList.toggle('error', !v3 && r.value !== ""); 
  a.classList.toggle('error', !v4 && a.value !== "");
  
  const startBtn = document.getElementById('stuStartBtn');
  const allValid = v1 && v2 && v3 && v4 && keyLoaded;
  
  if (v1 && v2 && v3 && v4) {
    const studentData = { name: n.value, sec: s.value, roll: r.value, adm: a.value };
    assignedForm = getAssignedForm(studentData);
    document.getElementById('resubmissionSection').style.display = 'none';
    document.getElementById('stuStartBtn').style.display = allValid ? "inline-block" : "none";
  } else {
    document.getElementById('resubmissionSection').style.display = 'none';
    document.getElementById('stuStartBtn').style.display = allValid ? "inline-block" : "none";
  }
  
  if (!keyLoaded) showError("Answer key not loaded - exam disabled. Contact administrator.");
  
  return allValid;
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessages');
    errorDiv.innerHTML = `<div class="error-message">${message}</div>`;
}

function clearErrors() {
    document.getElementById('errorMessages').innerHTML = '';
}

// ===== RESUBMISSION FUNCTIONALITY =====
function checkResubmission(studentData) {
    return false;
}

function verifyResubmissionPassword() {
    const enteredPassword = document.getElementById('resubmissionPassword').value.trim();
    
    if (enteredPassword === RESUBMISSION_PASSWORD) {
        isResubmission = true;
        document.getElementById('resubmissionSection').style.display = 'none';
        document.getElementById('stuStartBtn').style.display = 'inline-block';
        document.getElementById('errorMessages').innerHTML = '<div class="success-message">‚úÖ Password verified. You can now start the exam.</div>';
        return true;
    } else {
        document.getElementById('errorMessages').innerHTML = '<div class="error-message">‚ùå Incorrect password. Please try again.</div>';
        document.getElementById('resubmissionPassword').value = '';
        document.getElementById('resubmissionPassword').focus();
        return false;
    }
}

function cancelResubmission() {
    document.getElementById('resubmissionSection').style.display = 'none';
    document.getElementById('resubmissionPassword').value = '';
    document.getElementById('errorMessages').innerHTML = '';
    isResubmission = false;
}

// ===== ACCESS CODE VERIFICATION =====
function verifyAccessCode() {
    const enteredCode = document.getElementById('accessCode').value.trim();
    const errorElement = document.getElementById('accessError');
    const accessDenied = document.getElementById('accessDenied');
    
    errorElement.style.display = 'none';
    
    if (enteredCode === ACCESS_CODE) {
        accessDenied.style.display = 'none';
        document.getElementById('studentEntry').style.display = 'flex';
        document.getElementById('accessCode').value = '';
        document.getElementById('stuName').focus();
    } else {
        errorElement.style.display = 'block';
        document.getElementById('accessCode').value = '';
        document.getElementById('accessCode').focus();
        accessDenied.style.animation = 'shake 0.5s';
        setTimeout(() => accessDenied.style.animation = '', 500);
    }
}

// ===== SECURITY MEASURES =====
document.addEventListener('contextmenu', function(e) { e.preventDefault(); return false; });

document.addEventListener('keydown', function(e) {
    if (e.keyCode === 123 || 
        (e.ctrlKey && e.shiftKey && e.keyCode === 73) ||
        (e.ctrlKey && e.shiftKey && e.keyCode === 74) ||
        (e.ctrlKey && e.keyCode === 85) ||
        (e.ctrlKey && e.keyCode === 83) ||
        (e.ctrlKey && e.keyCode === 80) ||
        e.keyCode === 44 ||
        (e.ctrlKey && e.key === 'p') ||
        (e.metaKey && e.key === 'p')) {
        e.preventDefault(); e.stopPropagation(); return false;
    }
});

// ===== EVENT LISTENERS =====
["stuName", "stuSection", "stuRoll", "stuAdm"].forEach(id => {
  document.getElementById(id).addEventListener("input", validateStudentInputs);
});

document.getElementById('stuStartBtn').onclick = () => { 
  if (!validateStudentInputs()) return; 
  showConfirm("Start Exam?", startWithSecurity); 
};

document.getElementById('verifyResubmission').addEventListener('click', verifyResubmissionPassword);
document.getElementById('cancelResubmission').addEventListener('click', cancelResubmission);
document.getElementById('resubmissionPassword').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') verifyResubmissionPassword();
});
document.getElementById('verifyAccess').addEventListener('click', verifyAccessCode);
document.getElementById('accessCode').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') verifyAccessCode();
});

// ===== UTILITY FUNCTIONS =====
function shuffleArray(arr) {
    const c = arr.slice();
    for (let i = c.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [c[i], c[j]] = [c[j], c[i]];
    }
    return c;
}

function generateExamId() {
    return `exam_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

function generateStudentId(studentData) {
    return `${studentData.name}_${studentData.sec}_${studentData.roll}_${studentData.adm}`
        .toLowerCase()
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
}

// ===== START EXAM WITH SECURITY =====
function startWithSecurity(ok) {
  if (!ok) return;
  
  tabSwitchCount = 0;
  lastTabSwitchTime = 0;
  systemTrayDetector.reset();
  
  const stuName = document.getElementById('stuName');
  const stuSection = document.getElementById('stuSection');
  const stuRoll = document.getElementById('stuRoll');
  const stuAdm = document.getElementById('stuAdm');
  
  const studentKey = `${stuName.value}|${stuSection.value}|${stuRoll.value}|${stuAdm.value}`;
  
  examSecurity.enable().then(() => {
    startExam(studentKey);
  }).catch(err => {
    console.error('Failed to enable security:', err);
    alert('‚ö†Ô∏è Please allow full-screen mode to start the exam.');
  });
}

function startExam(studentKey) {
    if (!keyLoaded) {
        alert('Answer key not loaded. Contact admin.');
        return;
    }

    const stuName = document.getElementById('stuName');
    const stuSection = document.getElementById('stuSection');
    const stuRoll = document.getElementById('stuRoll');
    const stuAdm = document.getElementById('stuAdm');

    localStorage.setItem(studentKey, Date.now());
    prepareExamData();
    
    // Check if we have recovery data
    if (window.pendingRecoveryData) {
        progress = window.pendingRecoveryData.progress;
        examData = window.pendingRecoveryData.examData;
        examStartTime = window.pendingRecoveryData.metadata.examStartTime;
        assignedForm = window.pendingRecoveryData.metadata.assignedForm;
        
        // Calculate adjusted time
        const timeElapsed = Math.floor((Date.now() - examStartTime) / 1000);
        progress.timeLeftSec = Math.max(0, EXAM_DURATION_MINUTES * 60 - timeElapsed);
    } else {
        // Start fresh exam
        progress = {
            answers: Array(examData.files.length).fill(null),
            review: Array(examData.files.length).fill(false),
            currentIndex: 0,
            student: {name: stuName.value, sec: stuSection.value, roll: stuRoll.value, adm: stuAdm.value},
            timeLeftSec: EXAM_DURATION_MINUTES * 60
        };
        examStartTime = Date.now();
    }

    examInProgress = true;
    
    // Start keep-awake system
    keepAwakeSystem.start();
    
    document.getElementById('studentEntry').style.display = "none";
    document.getElementById('examArea').style.display = "block";
    renderQuestion(); 
    renderPalette(); 
    startTimer(); 
    updateNavButtons();
    
    // Enable all security systems
    systemTrayDetector.enable();
    
    saveExamProgress();
}

// ===== FIXED: UPDATE QUESTION INFO IN HEADER =====
function updateQuestionInfo() {
  const idx = progress.currentIndex;
  const stuInfoEl = document.getElementById('stuInfo');
  const stuQInfoEl = document.getElementById('stuQInfo');
  
  if (stuInfoEl) stuInfoEl.textContent = `${progress.student.name} | ${progress.student.sec} | Roll: ${progress.student.roll}`;
  if (stuQInfoEl) stuQInfoEl.textContent = `Question ${idx+1} of 75 | ${examData.subjectNames[idx]}`;
}

// ===== PALETTE FUNCTIONS =====
function renderPalette() {
  const container = document.getElementById('paletteContainer');
  container.innerHTML = '';
  
  for (let i = 0; i < examData.files.length; i++) {
    const btn = document.createElement('button');
    btn.className = 'palette-btn';
    btn.textContent = i + 1;
    btn.tabindex = "0";
    
    if (examData.questionTypes[i] === 'fill-blank') {
      btn.style.background = '#FFD700';
      btn.style.color = '#000';
    }
    
    if (progress.answers[i] !== null) btn.classList.add('selected');
    if (progress.review[i]) btn.classList.add('reviewed');
    if (i === progress.currentIndex) btn.classList.add('current');
    
    btn.onclick = () => {
      progress.currentIndex = i;
      renderQuestion();
      updateNavButtons();
    };
    
    container.appendChild(btn);
  }
}

function updatePalette() {
  const buttons = document.querySelectorAll('.palette-btn');
  buttons.forEach((btn, i) => {
    btn.className = 'palette-btn';
    
    if (examData.questionTypes[i] === 'fill-blank') {
      btn.style.background = '#FFD700';
      btn.style.color = '#000';
    } else {
      btn.style.background = '';
      btn.style.color = '';
    }
    
    if (progress.answers[i] !== null) btn.classList.add('selected');
    if (progress.review[i]) btn.classList.add('reviewed');
    if (i === progress.currentIndex) btn.classList.add('current');
  });
}

// ===== NAVIGATION FUNCTIONS =====
function updateNavButtons() {
  const idx = progress.currentIndex;
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const markReviewBtn = document.getElementById('markReviewBtn');
  
  prevBtn.disabled = idx === 0;
  nextBtn.disabled = idx === examData.files.length - 1;
  
  if (progress.review[idx]) {
    markReviewBtn.textContent = 'Unmark Review';
    markReviewBtn.style.background = 'linear-gradient(145deg, #dc3545, #c82333)';
  } else {
    markReviewBtn.textContent = 'Mark for Review';
    markReviewBtn.style.background = 'linear-gradient(145deg, #ffb84d, var(--warning))';
  }
}

document.getElementById('prevBtn').onclick = () => {
  if (progress.currentIndex > 0) {
    progress.currentIndex--;
    renderQuestion();
    updateNavButtons();
    
    if (examInProgress) {
      setTimeout(() => saveExamProgress(), 500);
    }
  }
};

document.getElementById('nextBtn').onclick = () => {
  if (progress.currentIndex < examData.files.length - 1) {
    progress.currentIndex++;
    renderQuestion();
    updateNavButtons();
    
    if (examInProgress) {
      setTimeout(() => saveExamProgress(), 500);
    }
  }
};

document.getElementById('markReviewBtn').onclick = () => {
  const idx = progress.currentIndex;
  progress.review[idx] = !progress.review[idx];
  updateNavButtons();
  updatePalette();
  
  if (examInProgress) {
    setTimeout(() => saveExamProgress(), 500);
  }
};

// ===== CONFIRMATION MODAL =====
document.getElementById('submitBtn').onclick = () => {
  showConfirmWithBothButtons("Submit Exam? You cannot change answers after submission.");
};

function showConfirmWithBothButtons(message) {
  const modal = document.getElementById('confirmModal');
  const text = document.getElementById('confirmText');
  const yesBtn = document.getElementById('confirmYes');
  const noBtn = document.getElementById('confirmNo');
  
  text.textContent = message;
  modal.style.display = 'flex';
  
  const newYesBtn = yesBtn.cloneNode(true);
  const newNoBtn = noBtn.cloneNode(true);
  yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
  noBtn.parentNode.replaceChild(newNoBtn, noBtn);
  
  newYesBtn.onclick = () => { 
    modal.style.display = 'none'; 
    submitExam(); 
  };
  
  newNoBtn.onclick = () => { 
    modal.style.display = 'none'; 
    console.log('User chose not to submit exam');
  };
}

function showConfirm(message, callback) {
  const modal = document.getElementById('confirmModal');
  const text = document.getElementById('confirmText');
  const yesBtn = document.getElementById('confirmYes');
  const noBtn = document.getElementById('confirmNo');
  
  text.textContent = message;
  modal.style.display = 'flex';
  
  const newYesBtn = yesBtn.cloneNode(true);
  const newNoBtn = noBtn.cloneNode(true);
  yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
  noBtn.parentNode.replaceChild(newNoBtn, noBtn);
  
  newYesBtn.onclick = () => { 
    modal.style.display = 'none'; 
    callback(true); 
  };
  
  newNoBtn.onclick = () => { 
    modal.style.display = 'none'; 
    callback(false); 
  };
}

// ===== TIMER FUNCTIONS =====
function startTimer() {
  timerInterval = setInterval(() => {
    progress.timeLeftSec--;
    
    const minutes = Math.floor(progress.timeLeftSec / 60);
    const seconds = progress.timeLeftSec % 60;
    const timerEl = document.getElementById('timerEl');
    
    timerEl.textContent = `üïí ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (progress.timeLeftSec <= 300) timerEl.classList.add('blink');
    
    if (progress.timeLeftSec <= 0) {
      clearInterval(timerInterval);
      submitExam();
    }
    
    if (progress.timeLeftSec % 60 === 0 && examInProgress) {
      saveExamProgress();
    }
  }, 1000);
}

// ===== GOOGLE FORMS SUBMISSION FUNCTIONS =====
function captureAllAnswersData() {
    console.log("üéØ Capturing all student answers for 75 questions...");
    
    const answersData = {
        student: progress.student,
        timestamp: new Date().toISOString(),
        examId: generateExamId(),
        assignedForm: assignedForm,
        answers: [],
        summary: {},
        structure: QUESTION_STRUCTURE
    };
    
    // Capture all 75 answers in original order
    for (let i = 0; i < examData.files.length; i++) {
        const originalIndex = examData.originalOrder[i];
        const questionType = examData.questionTypes[i];
        const answerRecord = {
            questionNumber: originalIndex + 1, // Original Q1-Q75
            shuffledPosition: i + 1, // Current position in exam
            subject: examData.subjectNames[i],
            questionType: questionType,
            studentAnswer: progress.answers[i] || 'N',
            correctAnswer: examData.keys[i],
            isCorrect: progress.answers[i] === examData.keys[i],
            isReviewed: progress.review[i]
        };
        
        answersData.answers.push(answerRecord);
    }
    
    // Sort by original question number (Q1-Q75)
    answersData.answers.sort((a, b) => a.questionNumber - b.questionNumber);
    
    // Calculate subject-wise summary
    const subjectSummary = {};
    answersData.answers.forEach(answer => {
        const subject = answer.subject;
        if (!subjectSummary[subject]) {
            subjectSummary[subject] = {
                total: 0,
                correct: 0,
                wrong: 0,
                notAttempted: 0,
                marks: 0,
                mcq: { total: 0, correct: 0 },
                fillBlank: { total: 0, correct: 0 }
            };
        }
        
        subjectSummary[subject].total++;
        
        // Track by question type
        if (answer.questionType === 'mcq') {
            subjectSummary[subject].mcq.total++;
            if (answer.isCorrect) subjectSummary[subject].mcq.correct++;
        } else {
            subjectSummary[subject].fillBlank.total++;
            if (answer.isCorrect) subjectSummary[subject].fillBlank.correct++;
        }
        
        if (answer.isCorrect) {
            subjectSummary[subject].correct++;
            subjectSummary[subject].marks += MARK_PER_CORRECT;
        } else if (answer.studentAnswer === 'N') {
            subjectSummary[subject].notAttempted++;
        } else {
            subjectSummary[subject].wrong++;
            subjectSummary[subject].marks += MARK_PER_WRONG;
        }
    });
    
    answersData.summary = subjectSummary;
    
    console.log("üìä Answers Data Captured:", {
        totalQuestions: answersData.answers.length,
        answered: answersData.answers.filter(a => a.studentAnswer !== 'N').length,
        correct: answersData.answers.filter(a => a.isCorrect).length,
        assignedForm: assignedForm
    });
    
    return answersData;
}

function formatAllAnswersString(answers) {
    console.log("üéØ Formatting 75 answers in ORIGINAL sequence...");
    
    // Create array for original order answers (Q1 to Q75)
    const originalOrderAnswers = new Array(75);
    
    // Map shuffled answers back to ORIGINAL order Q1-Q75
    examData.originalOrder.forEach((originalIndex, shuffledIndex) => {
        const studentAnswer = answers[shuffledIndex] || 'N';
        originalOrderAnswers[originalIndex] = studentAnswer;
    });
    
    // Join with commas
    const result = originalOrderAnswers.join(',');
    
    console.log("‚úÖ Answers formatted:");
    console.log("Total answers: 75");
    console.log("Answered:", answers.filter(a => a !== null).length);
    
    return result;
}

function calculateSubjectMarks(summary) {
    let maths = 0, physics = 0, chemistry = 0, total = 0;
    
    for (let subject in summary) {
        const subjectLower = subject.toLowerCase();
        if (subjectLower.includes('math')) maths = summary[subject].marks;
        else if (subjectLower.includes('phy')) physics = summary[subject].marks;
        else if (subjectLower.includes('chem')) chemistry = summary[subject].marks;
        total += summary[subject].marks;
    }
    
    return { maths, physics, chemistry, total };
}

async function submitToGoogleForms(answersData) {
    const FORM_URL = GOOGLE_FORMS[assignedForm];
    
    if (!FORM_URL) {
        console.error(`‚ùå No Google Form URL found for form ${assignedForm}`);
        updateSubmissionStatus('error', `No Google Form URL found for form ${assignedForm}`);
        saveSubmissionLocally(answersData);
        return false;
    }

    try {
        // Get the correct form fields for this section
        const formFields = getFormFields(assignedForm);
        
        // Prepare the form data
        const formData = new URLSearchParams();
        
        // Basic student information
        formData.append(formFields.STUDENT_NAME, answersData.student.name);
        formData.append(formFields.SECTION, answersData.student.sec);
        formData.append(formFields.ROLL_NUMBER, answersData.student.roll);
        formData.append(formFields.ADMISSION_NUMBER, answersData.student.adm);
        
        // Calculate and add marks
        const marks = calculateSubjectMarks(answersData.summary);
        formData.append(formFields.MATHS_MARKS, marks.maths.toFixed(2));
        formData.append(formFields.PHYSICS_MARKS, marks.physics.toFixed(2));
        formData.append(formFields.CHEMISTRY_MARKS, marks.chemistry.toFixed(2));
        formData.append(formFields.TOTAL_MARKS, marks.total.toFixed(2));
        
        // Add timestamp
        formData.append(formFields.TIMESTAMP, new Date().toLocaleString());
        
        // ADD ALL ANSWERS
        const allAnswersString = formatAllAnswersString(progress.answers);
        formData.append(formFields.ALL_ANSWERS, allAnswersString);
        
        console.log("üì§ Submitting to Google Forms:");
        console.log("Form:", assignedForm);
        console.log("Student:", answersData.student.name);
        console.log("Answers String:", allAnswersString.substring(0, 100) + "...");

        // Show pending status
        updateSubmissionStatus('pending', 'Submitting to Google Forms...');

        // Submit to Google Forms with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        
        const response = await fetch(FORM_URL, {
            method: "POST",
            mode: "no-cors",
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData,
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        console.log("‚úÖ Google Forms submission completed");
        updateSubmissionStatus('success', '‚úÖ Answers successfully submitted to Google Forms!');
        
        // Clear local storage after successful submission
        clearSavedExam();
        
        return true;
        
    } catch (error) {
        console.error("‚ùå Google Forms submission failed:", error);
        
        if (error.name === 'AbortError') {
            updateSubmissionStatus('error', '‚ùå Submission timeout. Your answers have been saved locally.');
        } else {
            updateSubmissionStatus('error', '‚ùå Failed to submit to Google Forms. Your answers have been saved locally.');
        }
        
        // Save locally for manual recovery
        saveSubmissionLocally(answersData);
        
        return false;
    }
}

function saveSubmissionLocally(answersData) {
    try {
        const localSubmissions = JSON.parse(localStorage.getItem('local_exam_submissions') || '[]');
        localSubmissions.push({
            ...answersData,
            savedAt: new Date().toISOString(),
            needsSync: true,
            form: assignedForm
        });
        
        localStorage.setItem('local_exam_submissions', JSON.stringify(localSubmissions));
        
        console.log('üíæ Submission saved locally for manual recovery');
        showToast('üíæ Submission saved locally. Contact administrator if needed.', 'warning', 5000);
        
    } catch (error) {
        console.error('‚ùå Failed to save submission locally:', error);
    }
}

function updateSubmissionStatus(status, message) {
    googleFormsSubmissionStatus = status;
    
    const statusDiv = document.getElementById('summarySubmissionStatus');
    if (statusDiv) {
        statusDiv.innerHTML = `<div class="submission-status submission-${status}">${message}</div>`;
    }
    
    const entryStatus = document.getElementById('googleFormsStatus');
    if (entryStatus) {
        entryStatus.innerHTML = `<div class="submission-status submission-${status}">${message}</div>`;
        entryStatus.style.display = 'block';
    }
}

async function submitToGoogleFormsWithRetry(answersData, maxRetries = 3) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            console.log(`üì§ Submission attempt ${attempt}/${maxRetries}`);
            
            if (!navigator.onLine) {
                console.log('üì¥ Offline - saving locally');
                saveSubmissionLocally(answersData);
                return { success: false, offline: true };
            }
            
            const success = await submitToGoogleForms(answersData);
            
            if (success) {
                return { success: true };
            }
            
            if (attempt < maxRetries) {
                // Wait before retry (exponential backoff)
                const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000);
                console.log(`‚è≥ Retrying in ${delay/1000} seconds...`);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
            
        } catch (error) {
            console.error(`‚ùå Submission error (attempt ${attempt}):`, error);
            
            if (attempt === maxRetries) {
                // Last attempt failed, save locally
                saveSubmissionLocally(answersData);
                return { success: false, error: error.message, savedLocally: true };
            }
        }
    }
    
    return { success: false, error: 'Max retries exceeded' };
}

// ===== SUBMISSION FUNCTIONS =====
function submitExam() {
  if (hasSubmitted) return;
  clearInterval(timerInterval);
  
  // Stop keep-awake system
  keepAwakeSystem.stop();
  
  if (autoSaveTimer) {
    clearInterval(autoSaveTimer);
    autoSaveTimer = null;
  }
  
  hasSubmitted = true;
  examInProgress = false;
  
  // Disable all security systems
  examSecurity.disable();
  systemTrayDetector.disable();
  
  const subjData = {};
  examData.subjectNames.forEach((s, i) => {
    const subjectName = identifySubject(s);
    if (!subjData[subjectName]) subjData[subjectName] = {
      correct: 0, wrong: 0, blank: 0, total: 0, marks: 0,
      mcq: { total: 0, correct: 0 },
      fillBlank: { total: 0, correct: 0 }
    };
    
    const ans = progress.answers[i];
    const questionType = examData.questionTypes[i];
    
    if (questionType === 'mcq') {
      subjData[subjectName].mcq.total++;
    } else {
      subjData[subjectName].fillBlank.total++;
    }
    
    if (ans === null) {
      subjData[subjectName].blank++;
    } else if (ans === examData.keys[i]) {
      subjData[subjectName].correct++;
      subjData[subjectName].marks += MARK_PER_CORRECT;
      
      if (questionType === 'mcq') {
        subjData[subjectName].mcq.correct++;
      } else {
        subjData[subjectName].fillBlank.correct++;
      }
    } else {
      subjData[subjectName].wrong++;
      subjData[subjectName].marks += MARK_PER_WRONG;
    }
    subjData[subjectName].total++;
  });

  currentSubjData = subjData;
  
  console.log("üéØ FINAL SUBMISSION DATA:");
  console.log("Student:", progress.student.name);
  console.log("Subject Data:", subjData);
  console.log("Tab switches:", tabSwitchCount);
  console.log("System tray violations:", systemTrayDetector.violationCount);

  // ===== GOOGLE FORMS SUBMISSION =====
  // Capture all answers data
  const answersData = captureAllAnswersData();
  
  // Submit to Google Forms with retry logic
  submitToGoogleFormsWithRetry(answersData).then(result => {
    if (result.success) {
      console.log('‚úÖ Google Forms submission successful');
      updateSubmissionStatus('success', '‚úÖ Answers successfully submitted to Google Forms!');
    } else if (result.offline) {
      console.log('üì¥ Submission saved offline');
      updateSubmissionStatus('error', 'üì¥ Submission saved offline. Will auto-retry when online.');
    } else {
      console.log('‚ùå Google Forms submission failed');
      updateSubmissionStatus('error', '‚ùå Failed to submit to Google Forms. Your answers have been saved locally.');
    }
  });

  // Show summary immediately
  showSummaryInterface(subjData);
}

function identifySubject(subjectName) {
  if (subjectName.includes('Math')) return 'Mathematics';
  if (subjectName.includes('Phy')) return 'Physics';
  if (subjectName.includes('Chem')) return 'Chemistry';
  return subjectName;
}

// ===== SUMMARY INTERFACE =====
function showSummaryInterface(subjData) {
  document.getElementById('examArea').style.display = 'none';
  document.getElementById('summaryArea').style.display = 'block';
  
  document.getElementById('summaryStudentName').textContent = progress.student.name;
  document.getElementById('summarySection').textContent = progress.student.sec;
  document.getElementById('summaryRoll').textContent = progress.student.roll;
  document.getElementById('summaryAdm').textContent = progress.student.adm;
  
  const table = document.createElement('table');
  table.className = 'results-table';
  table.innerHTML = `
    <thead>
      <tr>
        <th>Subject</th>
        <th>MCQ (Correct/Total)</th>
        <th>Numerical (Correct/Total)</th>
        <th>Total Correct</th>
        <th>Wrong</th>
        <th>Blank</th>
        <th>Total</th>
        <th>Marks</th>
      </tr>
    </thead>
    <tbody>
      ${Object.entries(subjData).map(([subject, data]) => `
        <tr>
          <td>${subject}</td>
          <td>${data.mcq.correct}/${data.mcq.total}</td>
          <td>${data.fillBlank.correct}/${data.fillBlank.total}</td>
          <td>${data.correct}</td>
          <td>${data.wrong}</td>
          <td>${data.blank}</td>
          <td>${data.total}</td>
          <td>${data.marks.toFixed(2)}</td>
        </tr>
      `).join('')}
      <tr class="total-row">
        <td><strong>Total</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.mcq.correct, 0)}/${Object.values(subjData).reduce((sum, d) => sum + d.mcq.total, 0)}</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.fillBlank.correct, 0)}/${Object.values(subjData).reduce((sum, d) => sum + d.fillBlank.total, 0)}</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.correct, 0)}</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.wrong, 0)}</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.blank, 0)}</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.total, 0)}</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.marks, 0).toFixed(2)}</strong></td>
      </tr>
    </tbody>
  `;
  
  document.getElementById('summaryTableContainer').innerHTML = '';
  document.getElementById('summaryTableContainer').appendChild(table);
  
  document.getElementById('autoTransitionMessage').style.display = 'block';
  let countdown = 5;
  document.getElementById('countdown').textContent = countdown;
  
  const countdownInterval = setInterval(() => {
    countdown--;
    document.getElementById('countdown').textContent = countdown;
    if (countdown <= 0) {
      clearInterval(countdownInterval);
      showDetailedSolutions();
    }
  }, 1000);
  
  document.getElementById('closeSummaryBtn').onclick = () => {
    clearInterval(countdownInterval);
    document.getElementById('summaryArea').style.display = 'none';
    document.getElementById('studentEntry').style.display = 'flex';
    resetForm();
  };
}

// ===== DETAILED SOLUTIONS =====
function showDetailedSolutions() {
  document.getElementById('summaryArea').style.display = 'none';
  document.getElementById('reviewArea').style.display = 'block';
  
  document.getElementById('reviewStudentName').textContent = progress.student.name;
  document.getElementById('reviewSection').textContent = progress.student.sec;
  document.getElementById('reviewRoll').textContent = progress.student.roll;
  document.getElementById('reviewAdm').textContent = progress.student.adm;
  
  const table = document.createElement('table');
  table.className = 'detailed-results-table';
  table.innerHTML = `
    <thead>
      <tr>
        <th>Subject</th>
        <th>MCQ (Correct/Total)</th>
        <th>Numerical (Correct/Total)</th>
        <th>Total Correct</th>
        <th>Wrong</th>
        <th>Blank</th>
        <th>Total</th>
        <th>Marks</th>
      </tr>
    </thead>
    <tbody>
      ${Object.entries(currentSubjData).map(([subject, data]) => `
        <tr>
          <td>${subject}</td>
          <td>${data.mcq.correct}/${data.mcq.total}</td>
          <td>${data.fillBlank.correct}/${data.fillBlank.total}</td>
          <td>${data.correct}</td>
          <td>${data.wrong}</td>
          <td>${data.blank}</td>
          <td>${data.total}</td>
          <td>${data.marks.toFixed(2)}</td>
        </tr>
      `).join('')}
      <tr class="total-row">
        <td><strong>Total</strong></td>
        <td><strong>${Object.values(currentSubjData).reduce((sum, d) => sum + d.mcq.correct, 0)}/${Object.values(currentSubjData).reduce((sum, d) => sum + d.mcq.total, 0)}</strong></td>
        <td><strong>${Object.values(currentSubjData).reduce((sum, d) => sum + d.fillBlank.correct, 0)}/${Object.values(currentSubjData).reduce((sum, d) => sum + d.fillBlank.total, 0)}</strong></td>
        <td><strong>${Object.values(currentSubjData).reduce((sum, d) => sum + d.correct, 0)}</strong></td>
        <td><strong>${Object.values(currentSubjData).reduce((sum, d) => sum + d.wrong, 0)}</strong></td>
        <td><strong>${Object.values(currentSubjData).reduce((sum, d) => sum + d.blank, 0)}</strong></td>
        <td><strong>${Object.values(currentSubjData).reduce((sum, d) => sum + d.total, 0)}</strong></td>
        <td><strong>${Object.values(currentSubjData).reduce((sum, d) => sum + d.marks, 0).toFixed(2)}</strong></td>
      </tr>
    </tbody>
  `;
  
  document.getElementById('detailedResultsContainer').innerHTML = '';
  document.getElementById('detailedResultsContainer').appendChild(table);
  
  const solutionsContainer = document.getElementById('reviewQuestionsContainer');
  solutionsContainer.innerHTML = '<h3 style="text-align:center; color:#4B0082; margin:30px 0;">Detailed Question Solutions</h3>';
  
  const sortedAnswers = [];
  for (let i = 0; i < examData.files.length; i++) {
    sortedAnswers.push({
      shuffledIndex: i,
      originalIndex: examData.originalOrder[i],
      studentAnswer: progress.answers[i],
      correctAnswer: examData.keys[i],
      subject: examData.subjectNames[i],
      type: examData.questionTypes[i]
    });
  }
  
  sortedAnswers.sort((a, b) => a.originalIndex - b.originalIndex);
  
  sortedAnswers.forEach((item, index) => {
    const solutionDiv = document.createElement('div');
    solutionDiv.className = 'solution-container';
    solutionDiv.style.cssText = 'margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px;';
    
    const isCorrect = item.studentAnswer === item.correctAnswer;
    const questionNumber = item.originalIndex + 1;
    
    solutionDiv.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <div class="solution-question" style="font-size: 18px; font-weight: bold; color: #4B0082;">
          Question ${questionNumber} (${item.subject}) - ${item.type === 'fill-blank' ? 'Numerical Input' : 'MCQ'}
        </div>
        <div style="font-size: 24px;">
          ${isCorrect ? '‚úÖ' : '‚ùå'}
        </div>
      </div>
      <div class="solution-answer ${isCorrect ? 'solution-correct' : 'solution-wrong'}" 
           style="padding: 10px; border-radius: 5px; margin: 10px 0; ${isCorrect ? 'background: #d4edda;' : 'background: #f8d7da;'}">
        <strong>Your Answer:</strong> ${item.studentAnswer || 'Not Attempted'} 
        ${!isCorrect && item.studentAnswer ? ` | <strong>Correct Answer:</strong> ${item.correctAnswer}` : ''}
      </div>
      <div class="solution-explanation" style="color: #666;">
        ${isCorrect ? 
          'You answered correctly!' : 
          item.studentAnswer ? 
          'Your answer was incorrect.' : 
          'You did not attempt this question.'}
      </div>
    `;
    
    solutionsContainer.appendChild(solutionDiv);
  });
  
  document.getElementById('closeReviewBtn').onclick = () => {
    document.getElementById('reviewArea').style.display = 'none';
    document.getElementById('studentEntry').style.display = 'flex';
    resetForm();
  };
}

// ===== DOWNLOAD FUNCTION =====
function downloadStudentCSV() {
  let csvContent = "Question,Subject,Type,Your Answer,Correct Answer,Status\n";
  
  const sortedData = [];
  for (let i = 0; i < examData.files.length; i++) {
    sortedData.push({
      questionNumber: examData.originalOrder[i] + 1,
      subject: examData.subjectNames[i],
      type: examData.questionTypes[i] === 'fill-blank' ? 'Numerical Input' : 'MCQ',
      studentAnswer: progress.answers[i] || 'Not Attempted',
      correctAnswer: examData.keys[i]
    });
  }
  
  sortedData.sort((a, b) => a.questionNumber - b.questionNumber);
  
  sortedData.forEach(item => {
    const status = item.studentAnswer === item.correctAnswer ? 'Correct' : 
                  item.studentAnswer === 'Not Attempted' ? 'Not Attempted' : 'Wrong';
    
    csvContent += `${item.questionNumber},${item.subject},${item.type},${item.studentAnswer},${item.correctAnswer},${status}\n`;
  });
  
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.setAttribute('hidden', '');
  a.setAttribute('href', url);
  a.setAttribute('download', `exam_results_${progress.student.name}_${progress.student.roll}.csv`);
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function resetForm() {
  document.getElementById('stuName').value = '';
  document.getElementById('stuSection').value = '';
  document.getElementById('stuRoll').value = '';
  document.getElementById('stuAdm').value = '';
  document.getElementById('googleFormsStatus').style.display = 'none';
  document.getElementById('resumeExamSection').style.display = 'none';
  window.pendingRecoveryData = null;
  validateStudentInputs();
}

// ===== ADMIN PASSWORD =====
document.getElementById('adminPassSubmit').addEventListener('click', function() {
  const adminPassInput = document.getElementById('adminPassInput');
  if (adminPassInput.value === ADMIN_PASSWORD) {
    adminOverrideActive = true;
    document.getElementById('adminPassModal').style.display = 'none';
    document.getElementById('fullRedOverlay').style.display = 'none';
    document.getElementById('accessDeniedBox').style.display = 'none';
    
    const stuName = document.getElementById('stuName');
    const stuSection = document.getElementById('stuSection');
    const stuRoll = document.getElementById('stuRoll');
    const stuAdm = document.getElementById('stuAdm');
    const studentKey = `${stuName.value}|${stuSection.value}|${stuRoll.value}|${stuAdm.value}`;
    startExam(studentKey);
  } else {
    alert("Incorrect password!");
    adminPassInput.value = '';
    adminPassInput.focus();
  }
});

document.getElementById('adminPassInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') document.getElementById('adminPassSubmit').click();
});

// ===== KEYBOARD SHORTCUTS =====
document.addEventListener('keydown', function(e) {
  if (document.getElementById('examArea').style.display === 'block') {
    const idx = progress.currentIndex;
    const questionType = examData.questionTypes[idx];
    
    if (questionType === 'fill-blank') {
      // Allow number keys
      if ((e.key >= '0' && e.key <= '9') || e.key === '.' || e.key === '-') {
        // Already handled by input field
      }
    } else {
      const keyMap = {'1': 'A', '2': 'B', '3': 'C', '4': 'D'};
      if (keyMap[e.key]) {
        e.preventDefault();
        selectOption(keyMap[e.key]);
      }
    }
    
    if (e.key === 'ArrowLeft') document.getElementById('prevBtn').click();
    if (e.key === 'ArrowRight') document.getElementById('nextBtn').click();
    if (e.key === ' ') document.getElementById('markReviewBtn').click();
  }
});

// ===== INITIAL SETUP =====
window.addEventListener('load', function() {
  console.log('LFJC Online Exam System Initialized (75 Questions)');
  console.log('üìö Question Structure:');
  console.log('‚Ä¢ Physics: Q1-20 (MCQ), Q21-25 (Numerical Input)');
  console.log('‚Ä¢ Chemistry: Q26-45 (MCQ), Q46-50 (Numerical Input)');
  console.log('‚Ä¢ Maths: Q51-70 (MCQ), Q71-75 (Numerical Input)');
  console.log('üîí Full-Screen Security Active');
  console.log('üìä Tab Switching Detection: 3 switches total submit exam');
  console.log('üîí System Tray & Search Bar Detection: 3 violations total submit exam');
  console.log('‚ö° POWER LOSS PROTECTION: Auto-save every 15 seconds');
  console.log('üì§ GOOGLE FORMS SUBMISSION: Enabled');
  console.log('üìÅ EXTERNAL ANSWER KEY: Will load from answer-key.txt');
  console.log('üñ±Ô∏è AUTO-CLICK SYSTEM: Clicks every 30 seconds to prevent screen sleep');
  console.log('üîã KEEP-AWAKE SYSTEM: Multiple layers to prevent screen sleep');
  
  document.getElementById('accessDenied').style.display = 'flex';
  document.getElementById('studentEntry').style.display = 'none';
  document.getElementById('examArea').style.display = 'none';
  document.getElementById('summaryArea').style.display = 'none';
  document.getElementById('reviewArea').style.display = 'none';
  document.getElementById('resubmissionSection').style.display = 'none';
  document.getElementById('googleFormsStatus').style.display = 'none';
  document.getElementById('resumeExamSection').style.display = 'none';
  
  document.getElementById('accessCode').focus();
  
  // Initialize System Tray Security
  systemTrayDetector = new SystemTrayViolationDetector();
  
  // Load answer key from external file
  loadAnswerKey().then(success => {
    if (success) {
      console.log("‚úÖ External answer key loaded successfully!");
      showToast('‚úÖ OK', 'success', 3000);
    }
  });
  
  // Initialize power loss protection
  setTimeout(() => {
    initPowerLossProtection();
  }, 1000);
});

console.log("üéØ LFJC Online Exam System Loaded Successfully");
console.log("üìÅ Loading answer key from: " + ANSWER_KEY_URL);
console.log("‚úÖ All security systems integrated: Full-screen, Tab switching, System tray, Power loss recovery");
console.log("üñ±Ô∏è Auto-click system enabled: Clicks every 30 seconds to prevent screen sleep");
console.log("üîã Keep-awake system: Wake Lock, silent video, keyboard activity, safe click zones");
</script>
</body>
</html>
